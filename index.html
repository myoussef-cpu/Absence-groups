<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة حضور الطلاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }
        
        .sidebar {
            width: 260px;
            transition: all 0.3s ease;
        }
        
        .main-content {
            margin-right: 260px;
            transition: all 0.3s ease;
        }
        
        .collapsed .sidebar {
            transform: translateX(100%);
            margin-left: -260px;
        }
        
        .collapsed .main-content {
            margin-right: 0;
        }
        
        .rtl-input {
            text-align: right;
            direction: rtl;
        }
        
        .attendance-present {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .attendance-absent {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        
        .payment-paid {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        .payment-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .offline-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="hidden fixed bottom-4 left-4 bg-yellow-500 text-white px-4 py-2 rounded-md shadow-lg offline-indicator z-50">
        <i class="fas fa-wifi-slash mr-2"></i> أنت تعمل في وضع عدم الاتصال
    </div>
    
    <!-- Sidebar -->
    <div id="appContainer" class="flex">
        <div class="sidebar fixed h-full bg-white shadow-lg z-40">
            <div class="flex items-center justify-between p-4 border-b">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center text-white">
                        <i class="fas fa-user-graduate text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold pr-2">إدارة الحضور</h1>
                </div>
                <button id="sidebarToggle" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            
            <div class="p-4">
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">القائمة الرئيسية</h3>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100 active-tab" data-tab="dashboard">
                                <i class="fas fa-home ml-2 text-purple-600"></i>
                                <span>الرئيسية</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" data-tab="groups">
                                <i class="fas fa-users ml-2 text-blue-600"></i>
                                <span>المجموعات</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" data-tab="attendance">
                                <i class="fas fa-clipboard-check ml-2 text-green-600"></i>
                                <span>تسجيل الحضور</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" data-tab="payments">
                                <i class="fas fa-money-bill-wave ml-2 text-yellow-600"></i>
                                <span>المدفوعات</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" data-tab="reports">
                                <i class="fas fa-chart-line ml-2 text-red-600"></i>
                                <span>التقارير</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" data-tab="schedule">
                                <i class="fas fa-calendar-alt ml-2 text-indigo-600"></i>
                                <span>الجدول الزمني</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="mt-8">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">الإعدادات</h3>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" data-tab="settings">
                                <i class="fas fa-cog ml-2 text-gray-600"></i>
                                <span>الإعدادات</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" id="backupBtn">
                                <i class="fas fa-database ml-2 text-gray-600"></i>
                                <span>النسخ الاحتياطي</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="flex items-center p-2 text-gray-700 rounded-lg hover:bg-gray-100" id="restoreBtn">
                                <i class="fas fa-upload ml-2 text-gray-600"></i>
                                <span>استعادة البيانات</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="absolute bottom-0 w-full p-4 border-t">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-user text-gray-600"></i>
                    </div>
                    <div class="pr-2">
                        <p class="font-medium">المستخدم</p>
                        <p class="text-sm text-gray-500">مدير النظام</p>
                    </div>
                    <button class="mr-auto text-gray-500 hover:text-gray-700">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content w-full">
            <!-- Header -->
            <header class="bg-white shadow-sm sticky top-0 z-30">
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center">
                        <button id="mobileSidebarToggle" class="md:hidden text-gray-500 hover:text-gray-700 mr-2">
                            <i class="fas fa-bars text-xl"></i>
                        </button>
                        <h2 id="pageTitle" class="text-xl font-bold">لوحة التحكم</h2>
                    </div>
                    
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button class="p-2 text-gray-500 hover:text-gray-700 relative">
                            <i class="fas fa-bell"></i>
                            <span class="absolute top-0 left-0 w-2 h-2 rounded-full bg-red-500"></span>
                        </button>
                        <div class="relative">
                            <input type="text" placeholder="بحث..." class="rtl-input pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <i class="fas fa-search absolute top-3 right-3 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="p-6">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-4">نظرة عامة</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500">إجمالي الطلاب</p>
                                        <p id="totalStudents" class="text-2xl font-bold">0</p>
                                    </div>
                                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                                        <i class="fas fa-users text-blue-600"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500">إجمالي المجموعات</p>
                                        <p id="totalGroups" class="text-2xl font-bold">0</p>
                                    </div>
                                    <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center">
                                        <i class="fas fa-layer-group text-purple-600"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500">نسبة الحضور</p>
                                        <p id="attendanceRate" class="text-2xl font-bold">0%</p>
                                    </div>
                                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                                        <i class="fas fa-clipboard-check text-green-600"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500">المدفوعات المتأخرة</p>
                                        <p id="pendingPayments" class="text-2xl font-bold">0</p>
                                    </div>
                                    <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center">
                                        <i class="fas fa-money-bill-wave text-yellow-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold">آخر الحضور</h4>
                                <a href="#" class="text-sm text-purple-600 hover:underline">عرض الكل</a>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-right py-2 px-4">الطالب</th>
                                            <th class="text-right py-2 px-4">المجموعة</th>
                                            <th class="text-right py-2 px-4">التاريخ</th>
                                            <th class="text-right py-2 px-4">الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentAttendance">
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-gray-500">لا توجد بيانات</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold">آخر المدفوعات</h4>
                                <a href="#" class="text-sm text-purple-600 hover:underline">عرض الكل</a>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-right py-2 px-4">الطالب</th>
                                            <th class="text-right py-2 px-4">المبلغ</th>
                                            <th class="text-right py-2 px-4">التاريخ</th>
                                            <th class="text-right py-2 px-4">الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentPayments">
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-gray-500">لا توجد بيانات</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold">حصص اليوم</h4>
                            <a href="#" class="text-sm text-purple-600 hover:underline">عرض الجدول الكامل</a>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="todayClasses">
                            <div class="p-4 border rounded-lg">
                                <p class="text-gray-500">لا توجد حصص اليوم</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Groups Tab -->
                <div id="groups" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">إدارة المجموعات</h3>
                        <button id="addGroupBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-plus ml-2"></i> إضافة مجموعة
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b flex justify-between items-center">
                            <div class="relative w-64">
                                <input type="text" placeholder="بحث في المجموعات..." class="rtl-input pl-10 pr-4 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="groupSearch">
                                <i class="fas fa-search absolute top-3 right-3 text-gray-400"></i>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="p-2 text-gray-500 hover:text-gray-700 border rounded-lg">
                                    <i class="fas fa-filter"></i>
                                </button>
                                <button class="p-2 text-gray-500 hover:text-gray-700 border rounded-lg">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">#</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">اسم المجموعة</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">عدد الطلاب</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">معدل الحضور</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="groupsList">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-gray-500">لا توجد مجموعات</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="p-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-500">عرض <span id="groupStart">0</span> إلى <span id="groupEnd">0</span> من <span id="groupTotal">0</span> مجموعات</div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="p-2 text-gray-500 hover:text-gray-700 border rounded-lg disabled" id="groupPrev">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                <button class="p-2 text-gray-500 hover:text-gray-700 border rounded-lg disabled" id="groupNext">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Attendance Tab -->
                <div id="attendance" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">تسجيل الحضور</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <div class="relative">
                                <select class="rtl-input pr-10 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="attendanceGroup">
                                    <option value="">اختر مجموعة</option>
                                </select>
                                <i class="fas fa-chevron-down absolute top-3 right-3 text-gray-400"></i>
                            </div>
                            <div class="relative">
                                <input type="date" class="rtl-input pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="attendanceDate">
                                <i class="fas fa-calendar-alt absolute top-3 right-3 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6" id="attendanceFormContainer" style="display: none;">
                        <div class="p-4 border-b">
                            <div class="flex justify-between items-center">
                                <h4 id="attendanceTitle" class="font-bold">تسجيل حضور المجموعة: <span id="selectedGroupName"></span> بتاريخ: <span id="selectedDate"></span></h4>
                                <button id="saveAttendanceBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                                    <i class="fas fa-save ml-2"></i> حفظ الحضور
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div id="attendanceLegend" class="flex space-x-4 space-x-reverse mb-4">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-green-100 border border-green-300 mr-2"></div>
                                    <span>حاضر</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-red-100 border border-red-300 mr-2"></div>
                                    <span>غائب</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-yellow-100 border border-yellow-300 mr-2"></div>
                                    <span>مؤجل</span>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-right py-2 px-4">اسم الطالب</th>
                                            <th class="text-right py-2 px-4">حالة الحضور</th>
                                            <th class="text-right py-2 px-4">ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceStudentsList">
                                        <!-- Students will be added here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden" id="attendanceHistoryContainer">
                        <div class="p-4 border-b">
                            <h4 class="font-bold">سجل الحضور</h4>
                        </div>
                        
                        <div class="p-4">
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-right py-2 px-4">التاريخ</th>
                                            <th class="text-right py-2 px-4">المجموعة</th>
                                            <th class="text-right py-2 px-4">عدد الحاضرين</th>
                                            <th class="text-right py-2 px-4">عدد الغائبين</th>
                                            <th class="text-right py-2 px-4">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceHistory">
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-gray-500">لا توجد سجلات حضور</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Payments Tab -->
                <div id="payments" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">إدارة المدفوعات</h3>
                        <button id="addPaymentBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-plus ml-2"></i> تسديد دفعة
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b">
                            <div class="flex justify-between items-center">
                                <h4 class="font-bold">المدفوعات المبكرة</h4>
                                <button class="text-purple-600 hover:underline">إظهار الكل</button>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="upcomingPayments">
                                <div class="border rounded-lg p-4">
                                    <p class="text-gray-500">لا توجد مدفوعات قادمة</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4 border-b">
                            <div class="flex justify-between items-center">
                                <h4 class="font-bold">سجل المدفوعات</h4>
                                <div class="flex space-x-2 space-x-reverse">
                                    <div class="relative">
                                        <select class="rtl-input pr-10 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="paymentFilter">
                                            <option value="all">كل المدفوعات</option>
                                            <option value="paid">مدفوعة</option>
                                            <option value="pending">غير مدفوعة</option>
                                        </select>
                                        <i class="fas fa-chevron-down absolute top-3 right-3 text-gray-400"></i>
                                    </div>
                                    <div class="relative">
                                        <input type="text" placeholder="بحث..." class="rtl-input pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" id="paymentSearch">
                                        <i class="fas fa-search absolute top-3 right-3 text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-right py-2 px-4">الطالب</th>
                                            <th class="text-right py-2 px-4">المجموعة</th>
                                            <th class="text-right py-2 px-4">المبلغ</th>
                                            <th class="text-right py-2 px-4">التاريخ</th>
                                            <th class="text-right py-2 px-4">الحالة</th>
                                            <th class="text-right py-2 px-4">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentsList">
                                        <tr>
                                            <td colspan="6" class="text-center py-4 text-gray-500">لا توجد سجلات مدفوعات</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Tab -->
                <div id="reports" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">التقارير والإحصائيات</h3>
                        <div class="flex space-x-2 space-x-reverse">
                            <button id="exportExcelBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                                <i class="fas fa-file-excel ml-2"></i> تصدير لإكسل
                            </button>
                            <button id="printReportBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                                <i class="fas fa-print ml-2"></i> طباعة
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b">
                            <div class="flex space-x-4 space-x-reverse">
                                <button class="font-medium border-b-2 border-purple-600 text-purple-600" data-report="attendance">تقارير الحضور</button>
                                <button class="font-medium text-gray-500 hover:text-gray-700" data-report="payments">تقارير المدفوعات</button>
                                <button class="font-medium text-gray-500 hover:text-gray-700" data-report="students">تقارير الطلاب</button>
                            </div>
                        </div>
                        
                        <div class="p-4" id="attendanceReport">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold mb-2">نسبة الحضور حسب المجموعة</h5>
                                    <div class="h-64" id="attendanceChart"></div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold mb-2">مقارنة الحضور شهرياً</h5>
                                    <div class="h-64" id="monthlyAttendanceChart"></div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h5 class="font-bold mb-2">تفاصيل الحضور</h5>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-right py-2 px-4">المجموعة</th>
                                                <th class="text-right py-2 px-4">عدد الطلاب</th>
                                                <th class="text-right py-2 px-4">إجمالي الحصص</th>
                                                <th class="text-right py-2 px-4">حضور</th>
                                                <th class="text-right py-2 px-4">غياب</th>
                                                <th class="text-right py-2 px-4">نسبة الحضور</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceDetails">
                                            <tr>
                                                <td colspan="6" class="text-center py-4 text-gray-500">لا توجد بيانات</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 hidden" id="paymentsReport">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold mb-2">حالة المدفوعات</h5>
                                    <div class="h-64" id="paymentsChart"></div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold mb-2">المدفوعات خلال السنة</h5>
                                    <div class="h-64" id="annualPaymentsChart"></div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h5 class="font-bold mb-2">تفاصيل المدفوعات</h5>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-right py-2 px-4">اسم الطالب</th>
                                                <th class="text-right py-2 px-4">المجموعة</th>
                                                <th class="text-right py-2 px-4">المبلغ المطلوب</th>
                                                <th class="text-right py-2 px-4">المبلغ المدفوع</th>
                                                <th class="text-right py-2 px-4">المبلغ المتبقي</th>
                                                <th class="text-right py-2 px-4">حالة الدفع</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paymentsDetails">
                                            <tr>
                                                <td colspan="6" class="text-center py-4 text-gray-500">لا توجد بيانات</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 hidden" id="studentsReport">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold mb-2">توزيع الطلاب حسب المجموعات</h5>
                                    <div class="h-64" id="studentsChart"></div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h5 class="font-bold mb-2">أفضل 5 طلاب من حيث الحضور</h5>
                                    <div class="h-64" id="topStudentsChart"></div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h5 class="font-bold mb-2">تفاصيل الطلاب</h5>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-right py-2 px-4">اسم الطالب</th>
                                                <th class="text-right py-2 px-4">المجموعة</th>
                                                <th class="text-right py-2 px-4">عدد الحصص</th>
                                                <th class="text-right py-2 px-4">حضور</th>
                                                <th class="text-right py-2 px-4">غياب</th>
                                                <th class="text-right py-2 px-4">نسبة الحضور</th>
                                            </tr>
                                        </thead>
                                        <tbody id="studentsDetails">
                                            <tr>
                                                <td colspan="6" class="text-center py-4 text-gray-500">لا توجد بيانات</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Schedule Tab -->
                <div id="schedule" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold">الجدول الزمني</h3>
                        <button id="addScheduleBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-plus ml-2"></i> إضافة حصة
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b">
                            <div class="flex space-x-4 space-x-reverse">
                                <button class="font-medium border-b-2 border-purple-600 text-purple-600" data-schedule="daily">جدول اليوم</button>
                                <button class="font-medium text-gray-500 hover:text-gray-700" data-schedule="weekly">جدول الأسبوع</button>
                                <button class="font-medium text-gray-500 hover:text-gray-700" data-schedule="monthly">جدول الشهر</button>
                            </div>
                        </div>
                        
                        <div class="p-4" id="dailySchedule">
                            <div class="mb-4 flex justify-between items-center">
                                <h4 id="scheduleDate" class="font-bold text-lg">حصص يوم الاثنين 10/10/2023</h4>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button id="prevDayBtn" class="p-2 rounded-lg border hover:bg-gray-50">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <button id="nextDayBtn" class="p-2 rounded-lg border hover:bg-gray-50">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div id="todaysClassesList" class="space-y-3">
                                <div class="p-4 border rounded-lg">
                                    <p class="text-gray-500">لا توجد حصص مجدولة اليوم</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 hidden" id="weeklySchedule">
                            <div class="mb-4 flex justify-between items-center">
                                <h4 id="scheduleWeek" class="font-bold text-lg">الأسبوع من 10/10/2023 إلى 16/10/2023</h4>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button id="prevWeekBtn" class="p-2 rounded-lg border hover:bg-gray-50">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <button id="nextWeekBtn" class="p-2 rounded-lg border hover:bg-gray-50">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th class="py-2 px-4 border">اليوم</th>
                                            <th class="py-2 px-4 border">الحصة الصباحية</th>
                                            <th class="py-2 px-4 border">الحصة المسائية</th>
                                            <th class="py-2 px-4 border">ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="weeklyClassesList">
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-gray-500">لا توجد حصص مجدولة هذا الأسبوع</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="p-4 hidden" id="monthlySchedule">
                            <div class="mb-4 flex justify-between items-center">
                                <h4 id="scheduleMonth" class="font-bold text-lg">جدول شهر أكتوبر 2023</h4>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button id="prevMonthBtn" class="p-2 rounded-lg border hover:bg-gray-50">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                    <button id="nextMonthBtn" class="p-2 rounded-lg border hover:bg-gray-50">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead>
                                        <tr>
                                            <th rowspan="2" class="py-2 px-4 border">المجموعة</th>
                                            <th colspan="31" class="text-center border">أيام الشهر</th>
                                        </tr>
                                        <tr>
                                            <!-- Days will be added dynamically -->
                                        </tr>
                                    </thead>
                                    <tbody id="monthlyClassesList">
                                        <tr>
                                            <td colspan="32" class="text-center py-4 text-gray-500">لا توجد حصص مجدولة هذا الشهر</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div id="settings" class="tab-content hidden">
                    <h3 class="text-lg font-bold mb-6">إعدادات النظام</h3>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b">
                            <h4 class="font-bold">الإعدادات العامة</h4>
                        </div>
                        
                        <div class="p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">اسم المدرسة/المركز</label>
                                    <input type="text" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل اسم المدرسة">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">شعار المدرسة/المركز</label>
                                    <div class="flex items-center">
                                        <div class="w-16 h-16 rounded-lg border mr-4 flex items-center justify-center">
                                            <i class="fas fa-image text-gray-400"></i>
                                        </div>
                                        <button class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                                            <i class="fas fa-upload ml-2"></i> رفع صورة
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">العملة</label>
                                    <select class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option>ريال سعودي (ر.س)</option>
                                        <option>دينار كويتي (د.ك)</option>
                                        <option>درهم إماراتي (د.إ)</option>
                                        <option>دولار أمريكي ($)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">التنبيهات</label>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="paymentReminder" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded mr-2">
                                            <label for="paymentReminder" class="text-sm text-gray-700">تنبيهات المدفوعات المتأخرة</label>
                                        </div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="classReminder" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded mr-2" checked>
                                            <label for="classReminder" class="text-sm text-gray-700">تنبيهات الحصص القادمة</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b">
                            <h4 class="font-bold">إعدادات الحضور</h4>
                        </div>
                        
                        <div class="p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">عدد الدقائق المسموح بها للتأخير</label>
                                    <input type="number" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="15" value="15">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">عدد الغيابات المسموح بها قبل الإشعار</label>
                                    <input type="number" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="3" value="3">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">التعريف الافتراضي للحضور</label>
                                    <select class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option>حاضر</option>
                                        <option>غائب</option>
                                        <option>مؤجل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">سمة جدول الحضور</label>
                                    <select class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <option>خيار واحد لكل طالب</option>
                                        <option>خيارات متعددة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
                        <div class="p-4 border-b">
                            <h4 class="font-bold">إعدادات المدفوعات</h4>
                        </div>
                        
                        <div class="p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">عدد الأيام المسموح بها قبل الإشعار</label>
                                    <input type="number" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="5" value="3">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">رسالة تذكير الدفع</label>
                                    <textarea class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="3" placeholder="رسالة تذكير الدفع...">عزيزي ولي الأمر، نذكركم بتسديد رسوم الدراسة قبل نهاية الفترة المحددة. شكراً لتعاونكم</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button class="gradient-bg text-white px-6 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-save ml-2"></i> حفظ الإعدادات
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Add Group Modal -->
    <div id="addGroupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">إضافة مجموعة جديدة</h3>
                    <button id="closeGroupModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">اسم المجموعة</label>
                        <input type="text" id="groupName" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل اسم المجموعة">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">وصف المجموعة</label>
                        <textarea id="groupDescription" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل وصف للمجموعة" rows="3"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">سعر الدورة (اختياري)</label>
                        <input type="number" id="groupPrice" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل السعر">
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button id="cancelGroupModal" class="px-4 py-2 border rounded-lg mr-2 hover:bg-gray-50">إلغاء</button>
                        <button id="saveGroupBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-save ml-2"></i> حفظ المجموعة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Group Modal -->
    <div id="viewGroupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="viewGroupTitle" class="text-lg font-bold">تفاصيل المجموعة</h3>
                    <button id="closeViewGroupModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="groupDetailsContent" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">وصف المجموعة</label>
                        <p id="groupViewDescription" class="bg-gray-50 p-3 rounded-lg">-</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">سعر الدورة</label>
                        <p id="groupViewPrice" class="bg-gray-50 p-3 rounded-lg">-</p>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <h4 class="text-md font-bold mb-3">قائمة الطلاب في هذه المجموعة (<span id="groupStudentsCount">0</span>)</h4>
                        
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center">
                                <input type="text" placeholder="بحث في الطلاب..." class="rtl-input pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent w-64" id="searchGroupStudents">
                                <i class="fas fa-search absolute top-3 right-3 text-gray-400"></i>
                            </div>
                            <button id="addStudentToGroupBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition text-sm">
                                <i class="fas fa-plus ml-2"></i> إضافة طالب
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b">
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">#</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">اسم الطالب</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">رقم الهاتف</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">الحالة المالية</th>
                                        <th class="px-6 py-3 text-right border-b font-medium text-gray-500">الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="groupStudentsList">
                                    <tr>
                                        <td colspan="5" class="text-center py-4 text-gray-500">لا توجد طلاب في هذه المجموعة</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <h4 class="text-md font-bold mb-3">إحصائيات الحضور للمجموعة</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-md bg-blue-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-users text-blue-600"></i>
                                    </div>
                                    <p class="text-gray-500">إجمالي الحصص</p>
                                </div>
                                <p id="groupTotalClasses" class="text-2xl font-bold mt-2">0</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-md bg-green-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-clipboard-check text-green-600"></i>
                                    </div>
                                    <p class="text-gray-500">متوسط الحضور</p>
                                </div>
                                <p id="groupAttendanceAvg" class="text-2xl font-bold mt-2">0%</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-md bg-yellow-100 flex items-center justify-center mr-3">
                                        <i class="fas fa-star text-yellow-600"></i>
                                    </div>
                                    <p class="text-gray-500">أفضل طالب</p>
                                </div>
                                <p id="groupTopStudent" class="text-2xl font-bold mt-2">-</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button id="closeViewGroupDetails" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-times ml-2"></i> إغلاق
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">إضافة طالب جديد</h3>
                    <button id="closeStudentModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">اسم الطالب</label>
                        <input type="text" id="studentName" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل اسم الطالب">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                        <input type="tel" id="studentPhone" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل رقم الهاتف">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
                        <textarea id="studentNotes" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أي ملاحظات إضافية" rows="2"></textarea>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button id="cancelStudentModal" class="px-4 py-2 border rounded-lg mr-2 hover:bg-gray-50">إلغاء</button>
                        <button id="saveStudentBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-save ml-2"></i> حفظ الطالب
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">تسديد دفعة</h3>
                    <button id="closePaymentModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الطالب</label>
                        <select id="paymentStudent" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">اختر طالب</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">المبلغ المدفوع</label>
                        <input type="number" id="paymentAmount" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أدخل المبلغ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">تاريخ الدفع</label>
                        <input type="date" id="paymentDate" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">طريقة الدفع</label>
                        <select id="paymentMethod" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="cash">نقداً</option>
                            <option value="bank">تحويل بنكي</option>
                            <option value="card">بطاقة ائتمانية</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات</label>
                        <textarea id="paymentNotes" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أي ملاحظات إضافية" rows="2"></textarea>
                    </div>
                    
                    <div>
                        <div id="paymentStats" class="bg-gray-50 p-3 rounded-lg hidden">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <p class="text-gray-500 text-sm">إجمالي المطلوب:</p>
                                    <p id="paymentTotal" class="font-bold">0 ر.س</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">المدفوع سابقاً:</p>
                                    <p id="paymentPaid" class="font-bold">0 ر.س</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">المتبقي:</p>
                                    <p id="paymentRemaining" class="font-bold">0 ر.س</p>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">حالة الدفع:</p>
                                    <p id="paymentStatus" class="font-bold">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button id="cancelPaymentModal" class="px-4 py-2 border rounded-lg mr-2 hover:bg-gray-50">إلغاء</button>
                        <button id="savePaymentBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-save ml-2"></i> حفظ الدفعة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Backup/Restore Modal -->
    <div id="backupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold" id="backupModalTitle">النسخ الاحتياطي</h3>
                    <button onclick="closeBackupModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4" id="backupContent">
                    <p>يمكنك تنزيل نسخة احتياطية من جميع بياناتك لحفظها على جهازك.</p>
                    <div class="flex items-center bg-blue-50 p-3 rounded-lg">
                        <i class="fas fa-info-circle text-blue-500 ml-2"></i>
                        <p class="text-sm">البيانات يتم تخزينها على متصفحك فقط. النسخ الاحتياطي يحفظ البيانات من الضياع.</p>
                    </div>
                    <button id="downloadBackupBtn" class="w-full gradient-bg text-white py-2 rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-download ml-2"></i> تحميل النسخة الاحتياطية
                    </button>
                </div>
                
                <div class="space-y-4 hidden" id="restoreContent">
                    <p>يمكنك استعادة البيانات من نسخة احتياطية سبق حفظها.</p>
                    <div class="flex items-center bg-yellow-50 p-3 rounded-lg">
                        <i class="fas fa-exclamation-triangle text-yellow-500 ml-2"></i>
                        <p class="text-sm">عند الاستعادة سيتم استبدال جميع البيانات الحالية.</p>
                    </div>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                        <input type="file" id="backupFile" class="hidden" accept=".json">
                        <label for="backupFile" class="cursor-pointer">
                            <i class="fas fa-file-upload text-4xl text-gray-400 mb-2"></i>
                            <p>انقر لاختيار ملف النسخة الاحتياطية</p>
                            <p id="selectedFileName" class="text-sm text-gray-500 mt-1">لم يتم اختيار ملف</p>
                        </label>
                    </div>
                    
                    <div class="flex justify-end pt-4">
                        <button id="confirmRestoreBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition" disabled>
                            <i class="fas fa-upload ml-2"></i> استعادة البيانات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div id="confirmDeleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">تأكيد الحذف</h3>
                    <button onclick="closeDeleteModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <p id="deleteMessage">هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذه العملية.</p>
                    
                    <div class="flex justify-end pt-4">
                        <button onclick="closeDeleteModal()" class="px-4 py-2 border rounded-lg mr-2 hover:bg-gray-50">إلغاء</button>
                        <button id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-trash-alt ml-2"></i> تأكيد الحذف
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Schedule Modal -->
    <div id="addScheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl overflow-hidden w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">إضافة حصة جديدة</h3>
                    <button id="closeScheduleModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">المجموعة</label>
                        <select id="scheduleGroup" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">اختر مجموعة</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">التاريخ</label>
                            <input type="date" id="scheduleDate" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">الوقت</label>
                            <input type="time" id="scheduleTime" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">مدة الحصة (بالساعات)</label>
                        <input type="number" id="scheduleDuration" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="1.5" step="0.5">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">الموضوع/التفاصيل</label>
                        <textarea id="scheduleDetails" class="rtl-input w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="أي تفاصيل إضافية" rows="2"></textarea>
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button id="cancelScheduleModal" class="px-4 py-2 border rounded-lg mr-2 hover:bg-gray-50">إلغاء</button>
                        <button id="saveScheduleBtn" class="gradient-bg text-white px-4 py-2 rounded-lg hover:shadow-lg transition">
                            <i class="fas fa-save ml-2"></i> حفظ الحصة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize data
        let groups = JSON.parse(localStorage.getItem('groups')) || [];
        let students = JSON.parse(localStorage.getItem('students')) || [];
        let attendances = JSON.parse(localStorage.getItem('attendances')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let schedules = JSON.parse(localStorage.getItem('schedules')) || [];
        
        // Check if it's the first run
        if (groups.length === 0) {
            // Create a sample group
            const sampleGroup = {
                id: generateId(),
                name: "المجموعة النموذجية",
                description: "مجموعة نموذجية لتجربة النظام",
                price: 1000,
                createdAt: new Date().toISOString()
            };
            groups.push(sampleGroup);
            localStorage.setItem('groups', JSON.stringify(groups));
            
            // Create a sample student
            const sampleStudent = {
                id: generateId(),
                name: "طالب نموذجي",
                phone: "0555555555",
                notes: "طالب نموذجي لأغراض العرض",
                groupId: sampleGroup.id,
                createdAt: new Date().toISOString()
            };
            students.push(sampleStudent);
            localStorage.setItem('students', JSON.stringify(students));
            
            // Create sample attendance
            const sampleAttendance = {
                id: generateId(),
                groupId: sampleGroup.id,
                date: new Date().toISOString().split('T')[0],
                records: [
                    {
                        studentId: sampleStudent.id,
                        status: "present",
                        notes: ""
                    }
                ],
                createdAt: new Date().toISOString()
            };
            attendances.push(sampleAttendance);
            localStorage.setItem('attendances', JSON.stringify(attendances));
            
            // Create sample schedule
            const today = new Date();
            const sampleSchedule = {
                id: generateId(),
                groupId: sampleGroup.id,
                date: today.toISOString().split('T')[0],
                time: "16:00",
                duration: 2,
                details: "حصة نموذجية لعرض النظام",
                createdAt: new Date().toISOString()
            };
            schedules.push(sampleSchedule);
            localStorage.setItem('schedules', JSON.stringify(schedules));
        }
        
        // DOM elements
        const appContainer = document.getElementById('appContainer');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const tabLinks = document.querySelectorAll('[data-tab]');
        const tabContents = document.querySelectorAll('.tab-content');
        const pageTitle = document.getElementById('pageTitle');
        const totalStudents = document.getElementById('totalStudents');
        const totalGroups = document.getElementById('totalGroups');
        const attendanceRate = document.getElementById('attendanceRate');
        const pendingPayments = document.getElementById('pendingPayments');
        const recentAttendance = document.getElementById('recentAttendance');
        const recentPayments = document.getElementById('recentPayments');
        const todayClasses = document.getElementById('todayClasses');
        const groupsList = document.getElementById('groupsList');
        const addGroupBtn = document.getElementById('addGroupBtn');
        const addGroupModal = document.getElementById('addGroupModal');
        const closeGroupModal = document.getElementById('closeGroupModal');
        const cancelGroupModal = document.getElementById('cancelGroupModal');
        const saveGroupBtn = document.getElementById('saveGroupBtn');
        const groupName = document.getElementById('groupName');
        const groupDescription = document.getElementById('groupDescription');
        const groupPrice = document.getElementById('groupPrice');
        const viewGroupModal = document.getElementById('viewGroupModal');
        const closeViewGroupModal = document.getElementById('closeViewGroupModal');
        const viewGroupTitle = document.getElementById('viewGroupTitle');
        const groupViewDescription = document.getElementById('groupViewDescription');
        const groupViewPrice = document.getElementById('groupViewPrice');
        const groupStudentsList = document.getElementById('groupStudentsList');
        const groupStudentsCount = document.getElementById('groupStudentsCount');
        const groupTotalClasses = document.getElementById('groupTotalClasses');
        const groupAttendanceAvg = document.getElementById('groupAttendanceAvg');
        const groupTopStudent = document.getElementById('groupTopStudent');
        const closeViewGroupDetails = document.getElementById('closeViewGroupDetails');
        const addStudentToGroupBtn = document.getElementById('addStudentToGroupBtn');
        const addStudentModal = document.getElementById('addStudentModal');
        const closeStudentModal = document.getElementById('closeStudentModal');
        const cancelStudentModal = document.getElementById('cancelStudentModal');
        const saveStudentBtn = document.getElementById('saveStudentBtn');
        const studentName = document.getElementById('studentName');
        const studentPhone = document.getElementById('studentPhone');
        const studentNotes = document.getElementById('studentNotes');
        const attendanceGroup = document.getElementById('attendanceGroup');
        const attendanceDate = document.getElementById('attendanceDate');
        const attendanceFormContainer = document.getElementById('attendanceFormContainer');
        const selectedGroupName = document.getElementById('selectedGroupName');
        const selectedDate = document.getElementById('selectedDate');
        const attendanceStudentsList = document.getElementById('attendanceStudentsList');
        const saveAttendanceBtn = document.getElementById('saveAttendanceBtn');
        const attendanceTitle = document.getElementById('attendanceTitle');
        const attendanceHistory = document.getElementById('attendanceHistory');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const addPaymentModal = document.getElementById('addPaymentModal');
        const closePaymentModal = document.getElementById('closePaymentModal');
        const cancelPaymentModal = document.getElementById('cancelPaymentModal');
        const savePaymentBtn = document.getElementById('savePaymentBtn');
        const paymentStudent = document.getElementById('paymentStudent');
        const paymentAmount = document.getElementById('paymentAmount');
        const paymentDate = document.getElementById('paymentDate');
        const paymentMethod = document.getElementById('paymentMethod');
        const paymentNotes = document.getElementById('paymentNotes');
        const paymentStats = document.getElementById('paymentStats');
        const paymentTotal = document.getElementById('paymentTotal');
        const paymentPaid = document.getElementById('paymentPaid');
        const paymentRemaining = document.getElementById('paymentRemaining');
        const paymentStatus = document.getElementById('paymentStatus');
        const paymentsList = document.getElementById('paymentsList');
        const upcomingPayments = document.getElementById('upcomingPayments');
        const backupBtn = document.getElementById('backupBtn');
        const restoreBtn = document.getElementById('restoreBtn');
        const backupModal = document.getElementById('backupModal');
        const backupModalTitle = document.getElementById('backupModalTitle');
        const backupContent = document.getElementById('backupContent');
        const restoreContent = document.getElementById('restoreContent');
        const downloadBackupBtn = document.getElementById('downloadBackupBtn');
        const backupFile = document.getElementById('backupFile');
        const selectedFileName = document.getElementById('selectedFileName');
        const confirmRestoreBtn = document.getElementById('confirmRestoreBtn');
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        const deleteMessage = document.getElementById('deleteMessage');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const reportTabs = document.querySelectorAll('[data-report]');
        const attendanceReport = document.getElementById('attendanceReport');
        const paymentsReport = document.getElementById('paymentsReport');
        const studentsReport = document.getElementById('studentsReport');
        const addScheduleBtn = document.getElementById('addScheduleBtn');
        const addScheduleModal = document.getElementById('addScheduleModal');
        const closeScheduleModal = document.getElementById('closeScheduleModal');
        const cancelScheduleModal = document.getElementById('cancelScheduleModal');
        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        const scheduleGroup = document.getElementById('scheduleGroup');
        const scheduleDate = document.getElementById('scheduleDate');
        const scheduleTime = document.getElementById('scheduleTime');
        const scheduleDuration = document.getElementById('scheduleDuration');
        const scheduleDetails = document.getElementById('scheduleDetails');
        const scheduleTabs = document.querySelectorAll('[data-schedule]');
        const dailySchedule = document.getElementById('dailySchedule');
        const weeklySchedule = document.getElementById('weeklySchedule');
        const monthlySchedule = document.getElementById('monthlySchedule');
        const scheduleDateTitle = document.getElementById('scheduleDate');
        const todaysClassesList = document.getElementById('todaysClassesList');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');
        const scheduleWeekTitle = document.getElementById('scheduleWeek');
        const weeklyClassesList = document.getElementById('weeklyClassesList');
        const prevWeekBtn = document.getElementById('prevWeekBtn');
        const nextWeekBtn = document.getElementById('nextWeekBtn');
        const scheduleMonthTitle = document.getElementById('scheduleMonth');
        const monthlyClassesList = document.getElementById('monthlyClassesList');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const printReportBtn = document.getElementById('printReportBtn');
        const offlineIndicator = document.getElementById('offlineIndicator');
        
        // Current date for the schedule
        let currentScheduleDate = new Date();
        
        // Helper functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }
        
        function formatDate(dateString) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return new Date(dateString).toLocaleDateString('ar-SA', options);
        }
        
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }
        
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        function formatCurrency(amount) {
            return amount ? `${amount} ر.س` : '-';
        }
        
        function formatPercentage(value) {
            return value ? `${Math.round(value * 100)}%` : '0%';
        }
        
        function updateDashboardStats() {
            // Total students
            totalStudents.textContent = students.length;
            
            // Total groups
            totalGroups.textContent = groups.length;
            
            // Attendance rate (calculate based on attendance records)
            const totalRecords = attendances.reduce((acc, attendance) => acc + attendance.records.length, 0);
            const presentRecords = attendances.reduce((acc, attendance) => {
                return acc + attendance.records.filter(r => r.status === 'present').length;
            }, 0);
            const rate = totalRecords > 0 ? presentRecords / totalRecords : 0;
            attendanceRate.textContent = formatPercentage(rate);
            
            // Pending payments
            const pending = students.filter(student => {
                const group = groups.find(g => g.id === student.groupId);
                if (!group || !group.price) return false;
                
                const studentPayments = payments.filter(p => p.studentId === student.id);
                const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
                return totalPaid < group.price;
            }).length;
            
            pendingPayments.textContent = pending;
            
            // Recent attendance (last 5)
            const recentAttendances = [...attendances].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            recentAttendance.innerHTML = '';
            if (recentAttendances.length > 0) {
                recentAttendances.forEach(attendance => {
                    const group = groups.find(g => g.id === attendance.groupId) || {};
                    const presentCount = attendance.records.filter(r => r.status === 'present').length;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="py-2 px-4">${getStudentName(attendance.records[0]?.studentId)}</td>
                        <td class="py-2 px-4">${group.name || '-'}</td>
                        <td class="py-2 px-4">${formatDate(attendance.date)}</td>
                        <td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${attendance.records[0]?.status === 'present' ? 'attendance-present' : 'attendance-absent'}">${attendance.records[0]?.status === 'present' ? 'حاضر' : 'غائب'}</span></td>
                    `;
                    recentAttendance.appendChild(tr);
                });
            } else {
                recentAttendance.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">لا توجد سجلات حضور حديثة</td></tr>';
            }
            
            // Recent payments (last 5)
            const recentPaymentsList = [...payments].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            recentPayments.innerHTML = '';
            if (recentPaymentsList.length > 0) {
                recentPaymentsList.forEach(payment => {
                    const student = students.find(s => s.id === payment.studentId) || {};
                    const group = groups.find(g => g.id === student.groupId) || {};
                    
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="py-2 px-4">${student.name || '-'}</td>
                        <td class="py-2 px-4">${formatCurrency(payment.amount)}</td>
                        <td class="py-2 px-4">${formatDate(payment.date)}</td>
                        <td class="py-2 px-4"><span class="px-2 py-1 rounded-full text-xs ${payment.status === 'paid' ? 'payment-paid' : 'payment-pending'}">${payment.status === 'paid' ? 'مدفوع' : 'غير مدفوع'}</span></td>
                    `;
                    recentPayments.appendChild(tr);
                });
            } else {
                recentPayments.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">لا توجد سجلات مدفوعات حديثة</td></tr>';
            }
            
            // Today's classes
            const today = getTodayDate();
            const todaysClasses = schedules.filter(s => s.date === today);
            
            todayClasses.innerHTML = '';
            if (todaysClasses.length > 0) {
                todaysClasses.forEach(cls => {
                    const group = groups.find(g => g.id === cls.groupId) || {};
                    
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between">
                            <div>
                                <h5 class="font-medium">${group.name || '-'}</h5>
                                <p class="text-sm text-gray-500">${formatTime(cls.time)} - ${cls.duration} ساعات</p>
                            </div>
                            <button class="text-purple-600 hover:text-purple-800" data-class-id="${cls.id}">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                        <p class="mt-2 text-gray-600 truncate">${cls.details || 'لا توجد تفاصيل'}</p>
                    `;
                    todayClasses.appendChild(div);
                });
            } else {
                todayClasses.innerHTML = '<div class="p-4 border rounded-lg"><p class="text-gray-500">لا توجد حصص اليوم</p></div>';
            }
        }
        
        function getStudentName(studentId) {
            const student = students.find(s => s.id === studentId);
            return student ? student.name : '-';
        }
        
        function renderGroupsList() {
            groupsList.innerHTML = '';
            
            if (groups.length > 0) {
                groups.forEach((group, index) => {
                    const studentsCount = students.filter(s => s.groupId === group.id).length;
                    const groupAttendance = attendances.filter(a => a.groupId === group.id);
                    
                    let attendanceRate = 0;
                    if (groupAttendance.length > 0) {
                        const totalRecords = groupAttendance.reduce((acc, attendance) => acc + attendance.records.length, 0);
                        const presentRecords = groupAttendance.reduce((acc, attendance) => {
                            return acc + attendance.records.filter(r => r.status === 'present').length;
                        }, 0);
                        attendanceRate = totalRecords > 0 ? presentRecords / totalRecords : 0;
                    }
                    
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${group.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${studentsCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="bg-purple-600 h-2.5 rounded-full" style="width: ${attendanceRate * 100}%"></div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-blue-600 hover:text-blue-800 view-group-btn" data-group-id="${group.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-yellow-600 hover:text-yellow-800 edit-group-btn" data-group-id="${group.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800 delete-group-btn" data-group-id="${group.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    groupsList.appendChild(tr);
                });
            } else {
                groupsList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">لا توجد مجموعات مسجلة</td></tr>';
            }
            
            // Add event listeners to view buttons
            document.querySelectorAll('.view-group-btn').forEach(btn => {
                btn.addEventListener('click', () => viewGroup(btn.dataset.groupId));
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-group-btn').forEach(btn => {
                btn.addEventListener('click', () => editGroup(btn.dataset.groupId));
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-group-btn').forEach(btn => {
                btn.addEventListener('click', () => confirmDelete('group', btn.dataset.groupId));
            });
        }
        
        function renderPaymentStudents() {
            paymentStudent.innerHTML = '<option value="">اختر طالب</option>';
            
            const studentsWithGroups = students.map(student => {
                const group = groups.find(g => g.id === student.groupId) || {};
                return {
                    ...student,
                    groupName: group.name || 'غير محدد'
                };
            });
            
            studentsWithGroups.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.groupName})`;
                paymentStudent.appendChild(option);
            });
        }
        
        function renderGroupStudents(groupId) {
            groupStudentsList.innerHTML = '';
            
            const groupStudents = students.filter(student => student.groupId === groupId);
            
            if (groupStudents.length > 0) {
                groupStudents.forEach((student, index) => {
                    const group = groups.find(g => g.id === student.groupId) || {};
                    const studentPayments = payments.filter(p => p.studentId === student.id);
                    const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
                    const paymentStatus = group.price ? (totalPaid >= group.price ? 'مكتمل' : 'غير مكتمل') : 'غير محدد';
                    
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.phone || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 rounded-full text-xs ${paymentStatus === 'مكتمل' ? 'payment-paid' : 'payment-pending'}">
                                ${paymentStatus}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-blue-600 hover:text-blue-800 view-student-btn" data-student-id="${student.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800 remove-student-btn" data-student-id="${student.id}">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    groupStudentsList.appendChild(tr);
                });
                
                // Add event listeners to view buttons
                document.querySelectorAll('.view-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => viewStudent(btn.dataset.studentId));
                });
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-student-btn').forEach(btn => {
                    btn.addEventListener('click', () => confirmDelete('student', btn.dataset.studentId));
                });
            } else {
                groupStudentsList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">لا توجد طلاب في هذه المجموعة</td></tr>';
            }
            
            groupStudentsCount.textContent = groupStudents.length;
        }
        
        function renderAttendanceGroupOptions() {
            attendanceGroup.innerHTML = '<option value="">اختر مجموعة</option>';
            
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                attendanceGroup.appendChild(option);
            });
        }
        
        function renderAttendanceForm(groupId, date) {
            attendanceFormContainer.style.display = 'block';
            selectedGroupName.textContent = groups.find(g => g.id === groupId)?.name || '';
            selectedDate.textContent = formatDate(date);
            
            const groupStudents = students.filter(student => student.groupId === groupId);
            attendanceStudentsList.innerHTML = '';
            
            // Check if there's existing attendance for this group and date
            const existingAttendance = attendances.find(a => 
                a.groupId === groupId && a.date === date
            );
            
            if (groupStudents.length > 0) {
                groupStudents.forEach(student => {
                    const existingRecord = existingAttendance?.records.find(r => r.studentId === student.id);
                    
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="py-2 px-4">${student.name}</td>
                        <td class="py-2 px-4">
                            <select class="rtl-input pr-8 py-1 border rounded focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-transparent attendance-status" data-student-id="${student.id}">
                                <option value="present" ${existingRecord?.status === 'present' ? 'selected' : ''}>حاضر</option>
                                <option value="absent" ${existingRecord?.status === 'absent' ? 'selected' : ''}>غائب</option>
                                <option value="late" ${existingRecord?.status === 'late' ? 'selected' : ''}>متأخر</option>
                            </select>
                        </td>
                        <td class="py-2 px-4">
                            <input type="text" class="rtl-input w-full px-2 py-1 border rounded focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-transparent attendance-notes" data-student-id="${student.id}" placeholder="ملاحظات" value="${existingRecord?.notes || ''}">
                        </td>
                    `;
                    attendanceStudentsList.appendChild(tr);
                });
            } else {
                attendanceStudentsList.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">لا توجد طلاب في هذه المجموعة</td></tr>';
            }
        }
        
        function renderAttendanceHistory() {
            attendanceHistory.innerHTML = '';
            
            if (attendances.length > 0) {
                const sortedAttendances = [...attendances].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedAttendances.forEach(attendance => {
                    const group = groups.find(g => g.id === attendance.groupId) || {};
                    const presentCount = attendance.records.filter(r => r.status === 'present').length;
                    const absentCount = attendance.records.length - presentCount;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-2 px-4">${formatDate(attendance.date)}</td>
                        <td class="py-2 px-4">${group.name || '-'}</td>
                        <td class="py-2 px-4 text-green-600">${presentCount}</td>
                        <td class="py-2 px-4 text-red-600">${absentCount}</td>
                        <td class="py-2 px-4">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-blue-600 hover:text-blue-800" data-attendance-id="${attendance.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-yellow-600 hover:text-yellow-800" data-attendance-id="${attendance.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800" data-attendance-id="${attendance.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    attendanceHistory.appendChild(tr);
                });
            } else {
                attendanceHistory.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">لا توجد سجلات حضور</td></tr>';
            }
        }
        
        function renderPaymentsList() {
            paymentsList.innerHTML = '';
            
            if (payments.length > 0) {
                const sortedPayments = [...payments].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedPayments.forEach(payment => {
                    const student = students.find(s => s.id === payment.studentId) || {};
                    const group = groups.find(g => g.id === student.groupId) || {};
                    
                    const tr = document.createElement('tr');
                    tr.className = 'border-b hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-2 px-4">${student.name || '-'}</td>
                        <td class="py-2 px-4">${group.name || '-'}</td>
                        <td class="py-2 px-4">${formatCurrency(payment.amount)}</td>
                        <td class="py-2 px-4">${formatDate(payment.date)}</td>
                        <td class="py-2 px-4">
                            <span class="px-2 py-1 rounded-full text-xs ${payment.status === 'paid' ? 'payment-paid' : 'payment-pending'}">
                                ${payment.status === 'paid' ? 'مدفوع' : 'غير مدفوع'}
                            </span>
                        </td>
                        <td class="py-2 px-4">
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-blue-600 hover:text-blue-800" data-payment-id="${payment.id}">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800 delete-payment-btn" data-payment-id="${payment.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    paymentsList.appendChild(tr);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-payment-btn').forEach(btn => {
                    btn.addEventListener('click', () => confirmDelete('payment', btn.dataset.paymentId));
                });
            } else {
                paymentsList.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">لا توجد سجلات مدفوعات</td></tr>';
            }
        }
        
        function renderUpcomingPayments() {
            upcomingPayments.innerHTML = '';
            
            // Get students with payment due in the next 7 days
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const upcomingPaymentsList = students.filter(student => {
                const group = groups.find(g => g.id === student.groupId);
                if (!group || !group.price) return false;
                
                const studentPayments = payments.filter(p => p.studentId === student.id);
                const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
                return totalPaid < group.price;
            });
            
            if (upcomingPaymentsList.length > 0) {
                upcomingPaymentsList.forEach(student => {
                    const group = groups.find(g => g.id === student.groupId) || {};
                    const studentPayments = payments.filter(p => p.studentId === student.id);
                    const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
                    const remaining = group.price - totalPaid;
                    
                    const div = document.createElement('div');
                    div.className = 'border rounded-lg p-4';
                    div.innerHTML = `
                        <div class="flex justify-between mb-2">
                            <h5 class="font-medium">${student.name}</h5>
                            <span class="text-sm">${group.name}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-xs text-gray-500">المطلوب</p>
                                <p class="font-bold">${formatCurrency(group.price)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500">المتبقي</p>
                                <p class="font-bold text-red-600">${formatCurrency(remaining)}</p>
                            </div>
                        </div>
                        <button class="mt-2 w-full gradient-bg text-white py-1 rounded-lg text-sm add-payment-btn" data-student-id="${student.id}">
                            <i class="fas fa-money-bill-wave ml-2"></i> تسديد دفعة
                        </button>
                    `;
                    upcomingPayments.appendChild(div);
                });
                
                // Add event listeners to add payment buttons
                document.querySelectorAll('.add-payment-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        paymentStudent.value = btn.dataset.studentId;
                        paymentStudent.dispatchEvent(new Event('change'));
                        addPaymentModal.classList.remove('hidden');
                        document.body.classList.add('overflow-hidden');
                    });
                });
            } else {
                upcomingPayments.innerHTML = '<div class="border rounded-lg p-4"><p class="text-gray-500">لا توجد مدفوعات قادمة</p></div>';
            }
        }
        
        function renderScheduleGroupOptions() {
            scheduleGroup.innerHTML = '<option value="">اختر مجموعة</option>';
            
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                scheduleGroup.appendChild(option);
            });
        }
        
        function renderDailySchedule(date) {
            const formattedDate = date.toISOString().split('T')[0];
            const dayClasses = schedules.filter(s => s.date === formattedDate);
            
            scheduleDateTitle.textContent = `حصص يوم ${getArabicDayName(date)} ${formatDate(formattedDate)}`;
            
            todaysClassesList.innerHTML = '';
            
            if (dayClasses.length > 0) {
                dayClasses.sort((a, b) => {
                    return a.time.localeCompare(b.time);
                }).forEach(cls => {
                    const group = groups.find(g => g.id === cls.groupId) || {};
                    
                    const div = document.createElement('div');
                    div.className = 'p-4 border rounded-lg hover:bg-gray-50';
                    div.innerHTML = `
                        <div class="flex justify-between">
                            <div>
                                <h5 class="font-medium">${group.name || '-'}</h5>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <i class="fas fa-clock ml-2"></i>
                                    <span>${formatTime(cls.time)} - ${cls.duration} ساعات</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 space-x-reverse">
                                <button class="text-purple-600 hover:text-purple-800 edit-schedule-btn" data-schedule-id="${cls.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-600 hover:text-red-800 delete-schedule-btn" data-schedule-id="${cls.id}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        <p class="mt-2 text-gray-600">${cls.details || 'لا توجد تفاصيل'}</p>
                    `;
                    todaysClassesList.appendChild(div);
                });
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.edit-schedule-btn').forEach(btn => {
                    btn.addEventListener('click', () => editSchedule(btn.dataset.scheduleId));
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
                    btn.addEventListener('click', () => confirmDelete('schedule', btn.dataset.scheduleId));
                });
            } else {
                todaysClassesList.innerHTML = '<div class="p-4 border rounded-lg"><p class="text-gray-500">لا توجد حصص مجدولة هذا اليوم</p></div>';
            }
        }
        
        function getArabicDayName(date) {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            return days[date.getDay()];
        }
        
        function renderWeeklySchedule(startDate) {
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            scheduleWeekTitle.textContent = `الأسبوع من ${formatDate(startDate.toISOString().split('T')[0])} إلى ${formatDate(endDate.toISOString().split('T')[0])}`;
            
            // Prepare days of the week
            const days = [];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                days.push(day.toISOString().split('T')[0]);
            }
            
            // Get all classes in this week
            const weekClasses = schedules.filter(s => 
                days.includes(s.date)
            );
            
            weeklyClassesList.innerHTML = '';
            
            if (weekClasses.length > 0) {
                days.forEach(day => {
                    const dayClasses = weekClasses.filter(s => s.date === day);
                    const dayDate = new Date(day);
                    const dayName = getArabicDayName(dayDate);
                    
                    if (dayClasses.length > 0) {
                        // Morning classes (before 12:00)
                        const morningClasses = dayClasses.filter(cls => parseInt(cls.time.split(':')[0]) < 12);
                        
                        // Afternoon classes (after 12:00)
                        const afternoonClasses = dayClasses.filter(cls => parseInt(cls.time.split(':')[0]) >= 12);
                        
                        const tr = document.createElement('tr');
                        tr.className = 'border';
                        tr.innerHTML = `
                            <td class="py-2 px-4 border font-medium">${dayName} ${formatDate(day)}</td>
                            <td class="py-2 px-4 border">
                                ${morningClasses.length > 0 ? morningClasses.map(cls => {
                                    const group = groups.find(g => g.id === cls.groupId) || {};
                                    return `${group.name} (${cls.time} - ${cls.duration} ساعات)`;
                                }).join('<br>') : '-'}
                            </td>
                            <td class="py-2 px-4 border">
                                ${afternoonClasses.length > 0 ? afternoonClasses.map(cls => {
                                    const group = groups.find(g => g.id === cls.groupId) || {};
                                    return `${group.name} (${cls.time} - ${cls.duration} ساعات)`;
                                }).join('<br>') : '-'}
                            </td>
                            <td class="py-2 px-4 border">
                                ${dayClasses.length > 0 ? 'محدد' : '-'}
                            </td>
                        `;
                        weeklyClassesList.appendChild(tr);
                    } else {
                        const tr = document.createElement('tr');
                        tr.className = 'border';
                        tr.innerHTML = `
                            <td class="py-2 px-4 border font-medium">${dayName} ${formatDate(day)}</td>
                            <td class="py-2 px-4 border">-</td>
                            <td class="py-2 px-4 border">-</td>
                            <td class="py-2 px-4 border">-</td>
                        `;
                        weeklyClassesList.appendChild(tr);
                    }
                });
            } else {
                weeklyClassesList.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">لا توجد حصص مجدولة هذا الأسبوع</td></tr>';
            }
        }
        
        function renderMonthlySchedule(year, month) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            
            const monthNames = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            scheduleMonthTitle.textContent = `جدول شهر ${monthNames[month]} ${year}`;
            
            // Get days header
            const daysHeader = document.querySelector('#monthlySchedule thead tr:last-child');
            daysHeader.innerHTML = '';
            
            for (let i = 1; i <= daysInMonth; i++) {
                const th = document.createElement('th');
                th.className = 'py-1 px-1 border text-xs';
                th.textContent = i;
                daysHeader.appendChild(th);
            }
            
            // Get monthly classes
            const monthStart = new Date(year, month, 1).toISOString().split('T')[0];
            const monthEnd = new Date(year, month + 1, 0).toISOString().split('T')[0];
            
            const monthClasses = schedules.filter(s => 
                s.date >= monthStart && s.date <= monthEnd
            );
            
            // Group classes by group
            const groupsWithClasses = groups.filter(group => 
                monthClasses.some(cls => cls.groupId === group.id)
            );
            
            monthlyClassesList.innerHTML = '';
            
            if (groupsWithClasses.length > 0) {
                groupsWithClasses.forEach(group => {
                    const tr = document.createElement('tr');
                    
                    // Group name cell
                    const groupCell = document.createElement('td');
                    groupCell.className = 'py-2 px-4 border font-medium';
                    groupCell.textContent = group.name;
                    tr.appendChild(groupCell);
                    
                    // Days cells
                    for (let i = 1; i <= daysInMonth; i++) {
                        const day = new Date(year, month, i);
                        const dayString = day.toISOString().split('T')[0];
                        
                        const dayClasses = monthClasses.filter(cls => 
                            cls.groupId === group.id && cls.date === dayString
                        );
                        
                        const td = document.createElement('td');
                        td.className = 'py-1 px-1 border text-xs';
                        
                        if (dayClasses.length > 0) {
                            td.innerHTML = '<div class="w-4 h-4 rounded-full bg-purple-500 mx-auto"></div>';
                            td.title = `${group.name} - ${formatTime(dayClasses[0].time)} - ${formatDate(dayString)}`;
                        }
                        
                        tr.appendChild(td);
                    }
                    
                    monthlyClassesList.appendChild(tr);
                });
            } else {
                monthlyClassesList.innerHTML = '<tr><td colspan="32" class="text-center py-4 text-gray-500">لا توجد حصص مجدولة هذا الشهر</td></tr>';
            }
        }
        
        function updatePaymentStats(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const group = groups.find(g => g.id === student.groupId);
            if (!group || typeof group.price !== 'number') {
                paymentStats.classList.add('hidden');
                return;
            }
            
            const studentPayments = payments.filter(p => p.studentId === student.id);
            const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
            const remaining = group.price - totalPaid;
            const status = remaining <= 0 ? 'مكتمل' : 'غير مكتمل';
            
            paymentTotal.textContent = formatCurrency(group.price);
            paymentPaid.textContent = formatCurrency(totalPaid);
            paymentRemaining.textContent = formatCurrency(remaining);
            paymentStatus.textContent = status;
            
            paymentStats.classList.remove('hidden');
        }
        
        // View functions
        function viewGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            viewGroupTitle.textContent = group.name;
            groupViewDescription.textContent = group.description || 'لا يوجد وصف';
            groupViewPrice.textContent = group.price ? formatCurrency(group.price) : 'غير محدد';
            
            // Render group students
            renderGroupStudents(groupId);
            
            // Calculate attendance stats
            const groupAttendance = attendances.filter(a => a.groupId === groupId);
            const totalClasses = groupAttendance.length;
            let totalPresent = 0;
            let totalRecords = 0;
            
            groupAttendance.forEach(attendance => {
                totalRecords += attendance.records.length;
                totalPresent += attendance.records.filter(r => r.status === 'present').length;
            });
            
            const attendanceAvg = totalRecords > 0 ? totalPresent / totalRecords : 0;
            groupTotalClasses.textContent = totalClasses;
            groupAttendanceAvg.textContent = formatPercentage(attendanceAvg);
            
            // Find top student
            if (totalClasses > 0) {
                const studentAttendance = {};
                students.forEach(student => {
                    if (student.groupId === groupId) {
                        studentAttendance[student.id] = 0;
                    }
                });
                
                groupAttendance.forEach(attendance => {
                    attendance.records.forEach(record => {
                        if (record.status === 'present') {
                            studentAttendance[record.studentId]++;
                        }
                    });
                });
                
                let topStudentId = '';
                let maxAttendance = 0;
                
                for (const [studentId, presentCount] of Object.entries(studentAttendance)) {
                    const student = students.find(s => s.id === studentId);
                    if (student && presentCount > maxAttendance) {
                        maxAttendance = presentCount;
                        topStudentId = studentId;
                    }
                }
                
                groupTopStudent.textContent = topStudentId ? students.find(s => s.id === topStudentId).name : '-';
            } else {
                groupTopStudent.textContent = '-';
            }
            
            viewGroupModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }
        
        function editGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            groupName.value = group.name;
            groupDescription.value = group.description || '';
            groupPrice.value = group.price || '';
            
            saveGroupBtn.dataset.groupId = groupId;
            document.title = `تعديل المجموعة: ${group.name}`;
            
            addGroupModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }
        
        function viewStudent(studentId) {
            // This would display student details in a modal
            console.log(`View student ${studentId}`);
        }
        
        function editSchedule(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            scheduleGroup.value = schedule.groupId;
            scheduleDate.value = schedule.date;
            scheduleTime.value = schedule.time;
            scheduleDuration.value = schedule.duration;
            scheduleDetails.value = schedule.details || '';
            
            saveScheduleBtn.dataset.scheduleId = scheduleId;
            document.title = `تعديل الحصة: ${groups.find(g => g.id === schedule.groupId)?.name || ''}`;
            
            addScheduleModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }
        
        // Delete functions
        function confirmDelete(type, id) {
            let message = '';
            
            switch(type) {
                case 'group':
                    const group = groups.find(g => g.id === id);
                    message = `هل أنت متأكد أنك تريد حذف المجموعة "${group?.name}"؟ سيتم أيضًا حذف جميع الطلاب والحضور المرتبطة بهذه المجموعة.`;
                    break;
                case 'student':
                    const student = students.find(s => s.id === id);
                    message = `هل أنت متأكد أنك تريد حذف الطالب "${student?.name}"؟ سيتم أيضًا حذف جميع سجلات الحضور والمدفوعات المرتبطة بهذا الطالب.`;
                    break;
                case 'attendance':
                    message = 'هل أنت متأكد أنك تريد حذف سجل الحضور هذا؟ لا يمكن التراجع عن هذه العملية.';
                    break;
                case 'payment':
                    message = 'هل أنت متأكد أنك تريد حذف سجل الدفع هذا؟ لا يمكن التراجع عن هذه العملية.';
                    break;
                case 'schedule':
                    message = 'هل أنت متأكد أنك تريد حذف هذه الحصة؟ لا يمكن التراجع عن هذه العملية.';
                    break;
                default:
                    return;
            }
            
            deleteMessage.textContent = message;
            confirmDeleteBtn.dataset.type = type;
            confirmDeleteBtn.dataset.id = id;
            
            confirmDeleteModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }
        
        function closeDeleteModal() {
            confirmDeleteModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        function deleteItem(type, id) {
            switch(type) {
                case 'group':
                    // Delete group and associated students, attendances, payments
                    groups = groups.filter(g => g.id !== id);
                    students = students.filter(s => s.groupId !== id);
                    attendances = attendances.filter(a => a.groupId !== id);
                    payments = payments.filter(p => students.some(s => s.id === p.studentId));
                    
                    localStorage.setItem('groups', JSON.stringify(groups));
                    localStorage.setItem('students', JSON.stringify(students));
                    localStorage.setItem('attendances', JSON.stringify(attendances));
                    localStorage.setItem('payments', JSON.stringify(payments));
                    
                    renderGroupsList();
                    break;
                
                case 'student':
                    // Delete student and associated attendances, payments
                    students = students.filter(s => s.id !== id);
                    attendances = attendances.map(attendance => {
                        return {
                            ...attendance,
                            records: attendance.records.filter(record => record.studentId !== id)
                        };
                    });
                    payments = payments.filter(p => p.studentId !== id);
                    
                    localStorage.setItem('students', JSON.stringify(students));
                    localStorage.setItem('attendances', JSON.stringify(attendances));
                    localStorage.setItem('payments', JSON.stringify(payments));
                    
                    renderGroupStudents(viewGroupTitle.dataset.groupId);
                    break;
                
                case 'attendance':
                    attendances = attendances.filter(a => a.id !== id);
                    localStorage.setItem('attendances', JSON.stringify(attendances));
                    renderAttendanceHistory();
                    break;
                
                case 'payment':
                    payments = payments.filter(p => p.id !== id);
                    localStorage.setItem('payments', JSON.stringify(payments));
                    renderPaymentsList();
                    renderUpcomingPayments();
                    break;
                
                case 'schedule':
                    schedules = schedules.filter(s => s.id !== id);
                    localStorage.setItem('schedules', JSON.stringify(schedules));
                    
                    // Refresh the current schedule view
                    const activeScheduleTab = document.querySelector('[data-schedule].font-medium.border-b-2');
                    if (activeScheduleTab) {
                        switch(activeScheduleTab.dataset.schedule) {
                            case 'daily':
                                renderDailySchedule(currentScheduleDate);
                                break;
                            case 'weekly':
                                renderWeeklySchedule(getWeekStartDate(currentScheduleDate));
                                break;
                            case 'monthly':
                                renderMonthlySchedule(currentScheduleDate.getFullYear(), currentScheduleDate.getMonth());
                                break;
                        }
                    }
                    break;
            }
            
            updateDashboardStats();
        }
        
        function getWeekStartDate(date) {
            const day = date.getDay(); // 0 is Sunday, 1 is Monday, etc.
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
            return new Date(date.setDate(diff));
        }
        
        // Backup functions
        function createBackup() {
            const backupData = {
                groups,
                students,
                attendances,
                payments,
                schedules,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportName = `attendance-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }
        
        function restoreBackup(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup data
                    if (!backupData.groups || !backupData.students || !backupData.attendances || !backupData.payments || !backupData.schedules) {
                        alert('الملف غير صالح. يرجى اختيار ملف نسخة احتياطية صالح.');
                        return;
                    }
                    
                    if (confirm('هل أنت متأكد أنك تريد استعادة النسخة الاحتياطية؟ جميع البيانات الحالية سيتم استبدالها.')) {
                        groups = backupData.groups;
                        students = backupData.students;
                        attendances = backupData.attendances;
                        payments = backupData.payments;
                        schedules = backupData.schedules;
                        
                        localStorage.setItem('groups', JSON.stringify(groups));
                        localStorage.setItem('students', JSON.stringify(students));
                        localStorage.setItem('attendances', JSON.stringify(attendances));
                        localStorage.setItem('payments', JSON.stringify(payments));
                        localStorage.setItem('schedules', JSON.stringify(schedules));
                        
                        alert('تم استعادة النسخة الاحتياطية بنجاح!');
                        location.reload(); // Refresh to update all views
                    }
                } catch (err) {
                    console.error('Error parsing backup file:', err);
                    alert('حدث خطأ أثناء معالجة ملف النسخة الاحتياطية. يرجى التأكد من أن الملف صالح.');
                }
            };
            
            reader.readAsText(file);
        }
        
        function closeBackupModal() {
            backupModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        
        // Event Listeners
        sidebarToggle.addEventListener('click', () => {
            appContainer.classList.toggle('collapsed');
            
            // Save sidebar state in localStorage
            const isCollapsed = appContainer.classList.contains('collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        });
        
        mobileSidebarToggle.addEventListener('click', () => {
            appContainer.classList.remove('collapsed');
        });
        
        // Initialize sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            appContainer.classList.add('collapsed');
        }
        
        // Tab switching
        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                const tabId = link.dataset.tab;
                
                // Update active tab
                tabLinks.forEach(t => t.classList.remove('active-tab'));
                link.classList.add('active-tab');
                
                // Show corresponding content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    content.classList.add('hidden');
                });
                
                document.getElementById(tabId).classList.add('active');
                document.getElementById(tabId).classList.remove('hidden');
                
                // Update page title
                pageTitle.textContent = link.querySelector('span').textContent;
                
                // Load data for this tab if needed
                switch(tabId) {
                    case 'groups':
                        renderGroupsList();
                        break;
                    case 'attendance':
                        renderAttendanceGroupOptions();
                        renderAttendanceHistory();
                        break;
                    case 'payments':
                        renderPaymentStudents();
                        renderPaymentsList();
                        renderUpcomingPayments();
                        break;
                    case 'schedule':
                        renderScheduleGroupOptions();
                        renderDailySchedule(currentScheduleDate);
                        break;
                }
            });
        });
        
        // Group form
        addGroupBtn.addEventListener('click', () => {
            groupName.value = '';
            groupDescription.value = '';
            groupPrice.value = '';
            
            saveGroupBtn.dataset.groupId = '';
            document.title = 'إضافة مجموعة جديدة';
            
            addGroupModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        
        closeGroupModal.addEventListener('click', () => {
            addGroupModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        cancelGroupModal.addEventListener('click', () => {
            addGroupModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        saveGroupBtn.addEventListener('click', () => {
            const name = groupName.value.trim();
            const description = groupDescription.value.trim();
            const price = parseFloat(groupPrice.value) || 0;
            const groupId = saveGroupBtn.dataset.groupId;
            
            if (!name) {
                alert('الرجاء إدخال اسم المجموعة');
                return;
            }
            
            if (groupId) {
                // Update existing group
                const index = groups.findIndex(g => g.id === groupId);
                if (index !== -1) {
                    groups[index] = {
                        ...groups[index],
                        name,
                        description,
                        price
                    };
                }
            } else {
                // Add new group
                groups.push({
                    id: generateId(),
                    name,
                    description,
                    price,
                    createdAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('groups', JSON.stringify(groups));
            addGroupModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            
            renderGroupsList();
            updateDashboardStats();
            
            // Update select options in other tabs
            renderAttendanceGroupOptions();
            renderScheduleGroupOptions();
        });
        
        // Close view group modal
        closeViewGroupModal.addEventListener('click', () => {
            viewGroupModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        closeViewGroupDetails.addEventListener('click', () => {
            viewGroupModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        // Student form
        addStudentToGroupBtn.addEventListener('click', () => {
            const groupId = viewGroupTitle.dataset.groupId;
            if (!groupId) return;
            
            studentName.value = '';
            studentPhone.value = '';
            studentNotes.value = '';
            
            saveStudentBtn.dataset.groupId = groupId;
            saveStudentBtn.dataset.studentId = '';
            
            addStudentModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        
        closeStudentModal.addEventListener('click', () => {
            addStudentModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        cancelStudentModal.addEventListener('click', () => {
            addStudentModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        saveStudentBtn.addEventListener('click', () => {
            const name = studentName.value.trim();
            const phone = studentPhone.value.trim();
            const notes = studentNotes.value.trim();
            const groupId = saveStudentBtn.dataset.groupId;
            const studentId = saveStudentBtn.dataset.studentId;
            
            if (!name) {
                alert('الرجاء إدخال اسم الطالب');
                return;
            }
            
            if (!groupId) {
                alert('حدث خطأ في تحديد المجموعة');
                return;
            }
            
            if (studentId) {
                // Update existing student
                const index = students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    students[index] = {
                        ...students[index],
                        name,
                        phone,
                        notes
                    };
                }
            } else {
                // Add new student
                students.push({
                    id: generateId(),
                    name,
                    phone,
                    notes,
                    groupId,
                    createdAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('students', JSON.stringify(students));
            addStudentModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            
            // Refresh the students list in the group view
            renderGroupStudents(groupId);
            updateDashboardStats();
            
            // Update payment students select
            renderPaymentStudents();
        });
        
        // Attendance form
        attendanceGroup.addEventListener('change', () => {
            const groupId = attendanceGroup.value;
            const date = attendanceDate.value;
            
            if (groupId && date) {
                renderAttendanceForm(groupId, date);
            }
        });
        
        attendanceDate.addEventListener('change', () => {
            const groupId = attendanceGroup.value;
            const date = attendanceDate.value;
            
            if (groupId && date) {
                renderAttendanceForm(groupId, date);
            }
        });
        
        // Set today's date as default
        attendanceDate.value = getTodayDate();
        
        saveAttendanceBtn.addEventListener('click', () => {
            const groupId = attendanceGroup.value;
            const date = attendanceDate.value;
            
            if (!groupId || !date) {
                alert('الرجاء تحديد المجموعة والتاريخ');
                return;
            }
            
            const attendanceRecords = [];
            const statusSelects = document.querySelectorAll('.attendance-status');
            const notesInputs = document.querySelectorAll('.attendance-notes');
            
            statusSelects.forEach((select, index) => {
                const studentId = select.dataset.studentId;
                const status = select.value;
                const notes = notesInputs[index].value.trim();
                
                attendanceRecords.push({
                    studentId,
                    status,
                    notes
                });
            });
            
            if (attendanceRecords.length === 0) {
                alert('لا يوجد طلاب في هذه المجموعة لتسجيل الحضور لهم');
                return;
            }
            
            // Check if attendance already exists for this group and date
            const existingIndex = attendances.findIndex(a => 
                a.groupId === groupId && a.date === date
            );
            
            if (existingIndex !== -1) {
                // Update existing attendance
                attendances[existingIndex].records = attendanceRecords;
            } else {
                // Add new attendance
                attendances.push({
                    id: generateId(),
                    groupId,
                    date,
                    records: attendanceRecords,
                    createdAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('attendances', JSON.stringify(attendances));
            
            alert('تم حفظ بيانات الحضور بنجاح');
            renderAttendanceHistory();
            updateDashboardStats();
        });
        
        // Payment form
        addPaymentBtn.addEventListener('click', () => {
            paymentStudent.value = '';
            paymentAmount.value = '';
            paymentDate.value = getTodayDate();
            paymentMethod.value = 'cash';
            paymentNotes.value = '';
            paymentStats.classList.add('hidden');
            
            addPaymentModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        
        closePaymentModal.addEventListener('click', () => {
            addPaymentModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        cancelPaymentModal.addEventListener('click', () => {
            addPaymentModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        paymentStudent.addEventListener('change', () => {
            updatePaymentStats(paymentStudent.value);
        });
        
        savePaymentBtn.addEventListener('click', () => {
            const studentId = paymentStudent.value;
            const amount = parseFloat(paymentAmount.value);
            const date = paymentDate.value;
            const method = paymentMethod.value;
            const notes = paymentNotes.value.trim();
            
            if (!studentId) {
                alert('الرجاء اختيار طالب');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('الرجاء إدخال مبلغ صحيح');
                return;
            }
            
            if (!date) {
                alert('الرجاء إدخال تاريخ صحيح');
                return;
            }
            
            payments.push({
                id: generateId(),
                studentId,
                amount,
                date,
                method,
                notes,
                status: 'paid',
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem('payments', JSON.stringify(payments));
            addPaymentModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            
            renderPaymentsList();
            renderUpcomingPayments();
            updateDashboardStats();
        });
        
        // Backup/restore
        backupBtn.addEventListener('click', () => {
            backupModalTitle.textContent = 'إنشاء نسخة احتياطية';
            backupContent.classList.remove('hidden');
            restoreContent.classList.add('hidden');
            
            backupModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        
        restoreBtn.addEventListener('click', () => {
            backupModalTitle.textContent = 'استعادة نسخة احتياطية';
            backupContent.classList.add('hidden');
            restoreContent.classList.remove('hidden');
            
            backupModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        
        downloadBackupBtn.addEventListener('click', createBackup);
        
        backupFile.addEventListener('change', () => {
            if (backupFile.files.length > 0) {
                selectedFileName.textContent = backupFile.files[0].name;
                confirmRestoreBtn.disabled = false;
            } else {
                selectedFileName.textContent = 'لم يتم اختيار ملف';
                confirmRestoreBtn.disabled = true;
            }
        });
        
        confirmRestoreBtn.addEventListener('click', () => {
            if (backupFile.files.length > 0) {
                restoreBackup(backupFile.files[0]);
                closeBackupModal();
            }
        });
        
        // Confirm delete
        confirmDeleteBtn.addEventListener('click', () => {
            const type = confirmDeleteBtn.dataset.type;
            const id = confirmDeleteBtn.dataset.id;
            
            deleteItem(type, id);
            closeDeleteModal();
        });
        
        // Report tabs
        reportTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                reportTabs.forEach(t => t.classList.remove('border-b-2', 'border-purple-600', 'text-purple-600'));
                tab.classList.add('border-b-2', 'border-purple-600', 'text-purple-600');
                
                attendanceReport.classList.add('hidden');
                paymentsReport.classList.add('hidden');
                studentsReport.classList.add('hidden');
                
                switch(tab.dataset.report) {
                    case 'attendance':
                        attendanceReport.classList.remove('hidden');
                        // Here you would load attendance charts
                        break;
                    case 'payments':
                        paymentsReport.classList.remove('hidden');
                        // Here you would load payment charts
                        break;
                    case 'students':
                        studentsReport.classList.remove('hidden');
                        // Here you would load student charts
                        break;
                }
            });
        });
        
        // Schedule tabs
        scheduleTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                scheduleTabs.forEach(t => t.classList.remove('border-b-2', 'border-purple-600', 'text-purple-600'));
                tab.classList.add('border-b-2', 'border-purple-600', 'text-purple-600');
                
                dailySchedule.classList.add('hidden');
                weeklySchedule.classList.add('hidden');
                monthlySchedule.classList.add('hidden');
                
                switch(tab.dataset.schedule) {
                    case 'daily':
                        dailySchedule.classList.remove('hidden');
                        renderDailySchedule(currentScheduleDate);
                        break;
                    case 'weekly':
                        weeklySchedule.classList.remove('hidden');
                        renderWeeklySchedule(getWeekStartDate(currentScheduleDate));
                        break;
                    case 'monthly':
                        monthlySchedule.classList.remove('hidden');
                        renderMonthlySchedule(currentScheduleDate.getFullYear(), currentScheduleDate.getMonth());
                        break;
                }
            });
        });
        
        // Schedule navigation
        prevDayBtn.addEventListener('click', () => {
            currentScheduleDate.setDate(currentScheduleDate.getDate() - 1);
            renderDailySchedule(currentScheduleDate);
        });
        
        nextDayBtn.addEventListener('click', () => {
            currentScheduleDate.setDate(currentScheduleDate.getDate() + 1);
            renderDailySchedule(currentScheduleDate);
        });
        
        prevWeekBtn.addEventListener('click', () => {
            currentScheduleDate.setDate(currentScheduleDate.getDate() - 7);
            renderWeeklySchedule(getWeekStartDate(currentScheduleDate));
        });
        
        nextWeekBtn.addEventListener('click', () => {
            currentScheduleDate.setDate(currentScheduleDate.getDate() + 7);
            renderWeeklySchedule(getWeekStartDate(currentScheduleDate));
        });
        
        prevMonthBtn.addEventListener('click', () => {
            currentScheduleDate.setMonth(currentScheduleDate.getMonth() - 1);
            renderMonthlySchedule(currentScheduleDate.getFullYear(), currentScheduleDate.getMonth());
        });
        
        nextMonthBtn.addEventListener('click', () => {
            currentScheduleDate.setMonth(currentScheduleDate.getMonth() + 1);
            renderMonthlySchedule(currentScheduleDate.getFullYear(), currentScheduleDate.getMonth());
        });
        
        // Add schedule
        addScheduleBtn.addEventListener('click', () => {
            scheduleGroup.value = '';
            scheduleDate.value = getTodayDate();
            scheduleTime.value = '16:00';
            scheduleDuration.value = '1.5';
            scheduleDetails.value = '';
            
            saveScheduleBtn.dataset.scheduleId = '';
            
            addScheduleModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });
        
        closeScheduleModal.addEventListener('click', () => {
            addScheduleModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        cancelScheduleModal.addEventListener('click', () => {
            addScheduleModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        });
        
        saveScheduleBtn.addEventListener('click', () => {
            const groupId = scheduleGroup.value;
            const date = scheduleDate.value;
            const time = scheduleTime.value;
            const duration = parseFloat(scheduleDuration.value);
            const details = scheduleDetails.value.trim();
            const scheduleId = saveScheduleBtn.dataset.scheduleId;
            
            if (!groupId) {
                alert('الرجاء اختيار مجموعة');
                return;
            }
            
            if (!date) {
                alert('الرجاء إدخال تاريخ صحيح');
                return;
            }
            
            if (!time) {
                alert('الرجاء إدخال وقت صحيح');
                return;
            }
            
            if (!duration || duration <= 0) {
                alert('الرجاء إدخال مدة صحيحة للحصة');
                return;
            }
            
            if (scheduleId) {
                // Update existing schedule
                const index = schedules.findIndex(s => s.id === scheduleId);
                if (index !== -1) {
                    schedules[index] = {
                        ...schedules[index],
                        groupId,
                        date,
                        time,
                        duration,
                        details
                    };
                }
            } else {
                // Add new schedule
                schedules.push({
                    id: generateId(),
                    groupId,
                    date,
                    time,
                    duration,
                    details,
                    createdAt: new Date().toISOString()
                });
            }
            
            localStorage.setItem('schedules', JSON.stringify(schedules));
            addScheduleModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            
            // Refresh the current schedule view
            const activeScheduleTab = document.querySelector('[data-schedule].font-medium.border-b-2');
            if (activeScheduleTab) {
                switch(activeScheduleTab.dataset.schedule) {
                    case 'daily':
                        renderDailySchedule(currentScheduleDate);
                        break;
                    case 'weekly':
                        renderWeeklySchedule(getWeekStartDate(currentScheduleDate));
                        break;
                    case 'monthly':
                        renderMonthlySchedule(currentScheduleDate.getFullYear(), currentScheduleDate.getMonth());
                        break;
                }
            }
            
            // Update today's classes on dashboard
            updateDashboardStats();
        });
        
        // Export to Excel
        exportExcelBtn.addEventListener('click', () => {
            // In a real implementation, you would generate an Excel file
            // This is a simplified version that just shows a message
            alert('سيتم تصدير البيانات إلى ملف Excel. في التطبيق الكامل، سيتم إنشاء ملف Excel فعليًا.');
        });
        
        // Print report
        printReportBtn.addEventListener('click', () => {
            // This would print the current report
            window.print();
        });
        
        // Online/offline detection
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        function updateOnlineStatus() {
            if (!navigator.onLine) {
                offlineIndicator.classList.remove('hidden');
            } else {
                offlineIndicator.classList.add('hidden');
            }
        }
        
        // Initialize
        updateDashboardStats();
        renderGroupsList();
        renderPaymentStudents();
        renderUpcomingPayments();
        updateOnlineStatus();
        
        // Show dashboard on initial load
        document.querySelector('[data-tab="dashboard"]').click();
    </script>
</body>
</html>
