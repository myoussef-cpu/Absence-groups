<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رفيق المعلم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #ec4899;
            --text-color: #1f2937;
            --background-color: #f9fafb;
            --surface-color: #ffffff;
            --border-color: #e5e7eb;
            --border-radius: 1rem;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --nav-height: 65px; /* Define navigation height */
        }

        body {
            font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif;
            direction: rtl;
            top: 50px;
            max-width: 1280px;
            margin: 0 auto;
            padding: calc(var(--nav-height) + 1rem) 1rem 1rem 1rem;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            position: relative;
            min-height: 100vh;
        }

        #mainContentContainer {
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.5s ease-out;
            margin-bottom: 1rem;
            min-height: calc(100vh - var(--nav-height) - 4rem);
        }

        .table-container {
            overflow-x: auto;
            margin: 1.5rem -2rem 0 -2rem;
            padding: 0rem;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: visible;
        }

        th:first-child {
            right: 0;
            z-index: 3;
            background-color: rgba(0, 0, 0, 0); /* تغيير خلفية العنوان لتكون شفافة */
            -webkit-backdrop-filter: blur(0px); /* Safari 9+ */
            backdrop-filter: blur(0px); /* Other modern browsers */
        }

        td:first-child {
            min-width: 150px; /* زيادة العرض الأدنى */
            padding: 4px;
            position: sticky;
            right: 0;
            z-index: 2;
            background-color: rgba(0, 0, 0, 0);
            -webkit-backdrop-filter: blur(0px);
            backdrop-filter: blur(0px);
            border-left: 2px solid var(--primary-color);
            box-shadow: -2px 0 5px rgba(0,0,200,0.1);
        }

        td:first-child:hover {
            background-color: #f8f9fa;
        }

        td:first-child::after,
        th:first-child::after {
            content: '';
            position: absolute;
            left: -5px;
            top: 0;
            height: 100%;
            width: 5px;
            background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
        }

        td:first-child input[type="text"],
        td:first-child .delete-student {
            position: relative;
            z-index: 2;
        }

        td input[type="text"],
        th input[type="text"] {
            width: 100%;
            text-align: right;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            margin: 0;
        }

        td:first-child input[type="text"] {
            width: calc(100% - 4px);
            box-sizing: border-box;
            margin: 2px;
            padding: 4px 8px;
            font-size: 0.9rem;
        }

        td:first-child .delete-student {
            width: calc(100% - 4px);
            margin: 2px;
            padding: 4px;
        }

        th, td {
            padding: 0.25rem;
            width: 20px;
            min-width: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        td:first-child {
            min-width: 80px;
            padding: 2px;
        }

        td input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 3px;
            cursor: pointer;
        }

        th input[type="date"] {
            width: 57px;
            text-align: right;
            padding: 0.25rem;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            direction: rtl;
        }

        td input[type="number"],
        .monthly-payment-input {
            text-align: left;
            direction: rtl;
        }

        .delete-student {
            display: block;
            width: 70%;
            margin: 2px 0;
            padding: 0.15rem;
            font-size: 0.7rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--text-color);
        }

        @media (max-width: 768px) {
             #mainContentContainer { padding: 1rem; }
             .table-container { margin: 1.5rem -1rem 0 -1rem; padding: 0 1rem; }
             body { padding: calc(var(--nav-height) + 0.5rem) 0.75rem 0.75rem 0.75rem; }
             th, td { padding: 0.5rem; font-size: 0.9rem; }
             td input[type="text"], th input[type="text"], th input[type="date"], td input[type="number"] {
                font-size: 0.9rem; padding: 0.01rem;
             }
             .delete-student { padding: 0.3rem 0.5rem; font-size: 0.8rem; margin-left: 0.25rem; }
             td:first-child input[type="text"]{ width: calc(100% - 55px); }
             td:first-child {
                min-width: 120px;
             }
             td:first-child input[type="text"] {
                font-size: 0.75rem;
             }
             .settings-grid, .home-stats-grid { grid-template-columns: 1fr; }
             .kpi-card { min-height: 120px; padding: 1rem; }
             .kpi-card .value { font-size: 1.8rem; }
             .top-arrears-card { padding: 1rem; }
             .top-arrears-card li { padding: 0.6rem 0; font-size: 0.9rem; }
             h1 { font-size: 2rem; }
             .search-box input { padding: 0.8rem 1rem; font-size: 1rem; }
             .search-box button { padding: 0.8rem 1.5rem; }
        }

        @media (max-width: 768px) {
            #mainContentContainer {
                padding: 0.5rem;
                margin: 0.25rem;
            }

            .table-container {
                margin: 1rem -0.5rem;
                padding: 0;
                width: calc(100% + 1rem);
            }

            body {
                padding: calc(var(--nav-height) + 0.5rem) 0.5rem 0.5rem 0.5rem;
            }

            .search-container {
                padding: 1rem;
                margin: 0.5rem 0;
            }

            .search-box {
                flex-direction: column;
            }

            .search-box input {
                min-width: unset;
                width: 80%;
            }

            .stats-container {
                padding: 0;
                margin: 0.5rem 0;
            }

            .stats-card {
                padding: 1rem;
                margin: 0.5rem 0;
            }

            .buttons-container {
                padding: 0;
                margin: 0.5rem 0;
                gap: 0.5rem;
            }

            .buttons-container button {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            .back-button {
                margin: 0.5rem 0;
                width: 100%;
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 1rem;
            }
        }

        /* تحسينات عرض المحتوى على الشاشات الصغيرة */
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
                overflow-x: hidden;
                width: 100%;
            }

            #mainContentContainer {
                padding: 0.75rem;
                margin: 0.25rem;
                width: calc(100% - 0.5rem);
                box-sizing: border-box;
                overflow-x: hidden;
            }

            .search-container {
                width: 100%;
                box-sizing: border-box;
                padding: 0.75rem;
            }

            .search-box {
                width: 100%;
                box-sizing: border-box;
            }

            .stats-grid,
            .home-stats-grid,
            .settings-grid {
                width: 100%;
                grid-template-columns: 1fr;
                padding: 0.5rem;
                box-sizing: border-box;
            }

            .current-group-card,
            .top-arrears-card,
            .stats-card {
                width: 100%;
                box-sizing: border-box;
                margin: 0.5rem 0;
                padding: 0.75rem;
            }

            .students-grid {
                grid-template-columns: 1fr;
                width: 100%;
                box-sizing: border-box;
            }

            .student-card {
                width: 100%;
                box-sizing: border-box;
            }

            .month-details {
                grid-template-columns: 1fr;
                width: 100%;
                box-sizing: border-box;
            }

            .attendance-details {
                max-width: 100%;
                overflow-x: auto;
            }

            .attendance-details table {
                min-width: 100%;
            }
        }

        /* تحسين العرض للأجهزة المتوسطة */
        @media (max-width: 768px) {
            .students-grid,
            .groups-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                padding: 0.5rem;
                width: 100%;
                box-sizing: border-box;
            }

            .group-card {
                width: 100%;
                box-sizing: border-box;
            }

            .group-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* تحسينات عامة للتوافق */
        .table-container {
            max-width: 100vw;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* For iOS momentum scrolling */
            overflow-scrolling: touch;
            /* Safari iOS < 16 alternative behavior */
            position: relative;
            z-index: 1;
        }

        .student-details {
            max-width: 100%;
            box-sizing: border-box;
        }

        .modal-details {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        /* Top Navigation Bar Styles */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            max-width: 90%;
            justify-content: center;
            gap: 1rem;
            background: var(--surface-color);
            padding: 0.5rem;
            border-radius: 0;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            margin-top: 0;
            border: 1px solid var(--border-color);
            border-top: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* إضافة وعاء خارجي للنافبار للتحكم في العرض */
        .top-nav::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 4rem); /* تعديل العرض ليكون أقل من المحتوى */
            max-width: calc(1280px - 4rem); /* تعديل العرض الأقصى */
            height: 100%;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .top-nav {
                padding: 0.25rem;
                gap: 0.25rem;
            }

            .nav-item {
                padding: 0.5rem;
                font-size: 0.7rem;
            }

            .nav-item i {
                font-size: 1.1rem;
            }
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 1rem;
            color: var(--text-color);
            background: none;
            border: none;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
            font-family: inherit;
            min-width: 60px;
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .nav-item:hover {
            transform: translateY(-2px);
            background: rgba(99, 102, 241, 0.05);
        }

        /* Footer */
        .copyright { text-align: center; padding: 1rem; margin-top: 2rem; color: var(--text-color); font-size: 0.9rem; border-top: 1px solid var(--border-color); }

        /* Back Button */
        .back-button {
            position: sticky; top: 1rem; z-index: 100; -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px); background: rgba(99, 102, 241, 0.9);
            color: white; border: none; padding: 0.6rem 1.2rem; border-radius: var(--border-radius);
            cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;
            box-shadow: var(--shadow); display: inline-flex; align-items: center; gap: 0.5rem;
            margin-bottom: 1rem; width: auto;
         }
         .back-button:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: var(--shadow-lg); }

        /* General Styles */
         h1 { color: var(--primary-color); text-align: center; margin-bottom: 2rem; font-size: 2.5rem; font-weight: 800; background: linear-gradient(to left, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; position: relative; padding-bottom: 1rem; }
        h1:after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100px; height: 4px; background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); border-radius: 2px; }
        #mainContentContainer > h1 { margin-top: 0; }
        button { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); color: white; border: none; padding: 0.875rem 1.5rem; border-radius: var(--border-radius); cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; box-shadow: var(--shadow); position: relative; overflow: hidden; font-family: inherit; }
        button:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); filter: brightness(110%); }
        button:active { transform: translateY(0); box-shadow: var(--shadow-sm); }
        button::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(transparent, rgba(255,255,255,0.2), transparent); transform: rotate(45deg); transition: 0.5s; }
        button:hover::after { left: 100%; }

        /* Search */
        .search-container { background: rgba(255, 255, 255, 0.95); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); margin-bottom: 2rem; backdrop-filter: blur(10px); border: 1px solid rgba(99, 102, 241, 0.1); position: relative; z-index: 2; }
        .search-box { display: flex; gap: 1rem; margin-bottom: 0; }
        .search-box input { flex: 1; padding: 1rem 1.5rem; border: 2px solid var(--border-color); border-radius: var(--border-radius); font-size: 1.1rem; transition: all 0.3s ease; background: white; min-width: 250px; }
        .search-box input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); outline: none; }
        .search-box button { padding: 1rem 2rem; white-space: nowrap; display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
        .search-box i { font-size: 1.2rem; }
        .search-result { padding: 1rem; margin: 0.75rem 0; background: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .search-result:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: var(--primary-color); }
        .search-results { margin-top: 1.5rem; }

        /* Buttons Container */
        .buttons-container { display: flex; gap: 10px; flex-wrap: wrap; margin: 1.5rem 0; justify-content: center; }
        @media (max-width: 768px) { .buttons-container button { width: calc(50% - 5px); font-size: 0.9rem; padding: 0.75rem 1rem; } .buttons-container button:last-child:nth-child(odd) { width: 100%; } }

        /* Delete Buttons */
        .delete-button { background: linear-gradient(to right, #e74c3c, #c0392b); }
        .delete-button:hover { filter: brightness(115%); background: linear-gradient(to right, #c0392b, #e74c3c); }
        .delete-student { background-color: #dc3545; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; margin-left: 0.5rem; border: none; cursor: pointer; font-size: 0.9rem; vertical-align: middle; }
        .delete-student:hover { background-color: #c82333; }

        /* Statistics Page Styles */
        .stats-container { margin: 1.5rem 0; display: grid; gap: 1.5rem; }
        .stats-card { background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 0; box-shadow: var(--shadow-sm); transition: all 0.3s ease; border: 1px solid var(--border-color); }
        .stats-card h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; }
        .stats-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; text-align: center; }
        .stats-grid div h3 { font-size: 1rem; color: var(--text-color); margin-bottom: 0.5rem; font-weight: 600; }
        .stats-grid div p { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin: 0; }

        /* Unpaid Student List (Statistics Page) */
        .students-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; padding: 0; }
        .student-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1rem; cursor: pointer; transition: all 0.3s ease; margin-bottom: 0; }
        .student-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .student-card.active { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .student-details { display: none; background: #f9fafb; padding: 1rem; margin-top: 1rem; border-radius: 0.75rem; border: 1px solid var(--border-color); }
        .student-details.show { display: block; animation: fadeIn 0.3s ease-out; }
        .student-name { font-weight: bold; color: var(--primary-hover); display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 1.1rem; }
        .student-name .badge { background: #dc3545; color: white; padding: 0.25rem 0.6rem; border-radius: 0.75rem; font-size: 0.8em; font-weight: normal; }
        .group-badge { background: var(--secondary-color); color: white; padding: 0.25rem 0.6rem; border-radius: 0.75rem; font-size: 0.8em; font-weight: normal; }
        .month-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
        .month-item { padding: 0.75rem; background: var(--surface-color); border-radius: 0.5rem; font-size: 0.9em; border: 1px solid var(--border-color); }

        /* Table Inputs/Actions */
        .monthly-payment-input { width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem; text-align: center; font-size: 1rem; box-sizing: border-box; }
        .monthly-payment-input:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1); }
        .month-actions { display: inline-flex; align-items: center; gap: 5px; margin-right: 5px; vertical-align: middle; }
        .action-icon { cursor: pointer; padding: 2px 6px; border-radius: 50%; font-size: 0.9rem; transition: all 0.2s ease; color: white; line-height: 1; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; }
        .delete-month { background-color: #dc3545; }
        .add-month { background-color: #28a745; }
        .action-icon:hover { opacity: 0.8; transform: scale(1.1); }

        /* Groups Page */
        .groups-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; padding: 1rem 0; }
        .group-card { background: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; margin-bottom: 0; overflow: hidden; }
        .group-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .group-card h3 { color: var(--primary-color); margin-top: 0; margin-bottom: 1rem; font-size: 1.25rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .group-card h3 .toggle-details { transition: transform 0.3s ease; color: var(--secondary-color); font-size: 1rem; padding: 0.5rem; display: inline-block; }
        .group-card.expanded h3 .toggle-details { transform: rotate(180deg); }
        .group-details { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; pointer-events: none; }
        .group-card.expanded .group-details { max-height: 600px; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); pointer-events: auto; }
        .group-card.expanded .group-details button, .group-card.expanded .group-details a { pointer-events: auto; }
        .group-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .stat-item { background: #f8f9fa; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.9em; }
        .stat-item span { display: block; color: #666; margin-bottom: 0.25rem; font-size: 0.9em; }
        .stat-item strong { color: var(--primary-color); font-size: 1.1em; }
        .group-students { margin-top: 1rem; }
        .student-list { margin: 0; padding: 0; list-style: none; }
        .student-list li { padding: 0.6rem 0; border-bottom: 1px solid var(--border-color); font-size: 0.95rem; }
        .student-list li:last-child { border-bottom: none; }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 1rem;
            left: 6rem;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 1001;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .connection-status.online { background-color: #22c55e; }
        .connection-status.offline { background-color: #ef4444; }
        .connection-status .icon { display: none; }
        .connection-status .status-text { display: none; }

        /* Splash Screen */
        .splash-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.8s ease-out, transform 0.8s ease-out; overflow: hidden; }
        .splash-screen::before { content: ''; position: absolute; width: 200%; height: 200%; background: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%); background-size: 60px 60px; animation: moveStripes 3s linear infinite; opacity: 0.2; }
        .splash-screen::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at center, transparent 50%, rgba(0,0,0,0.2) 100%); }
        .splash-logo { width: 150px; height: 150px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; box-shadow: 0 0 40px rgba(255,255,255,0.3); animation: logoEntrance 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55), pulse 2s infinite 1.2s; position: relative; z-index: 1; }
        .splash-logo img { width: 80%; height: 80%; object-fit: contain; border-radius: 50%; }
        .splash-title { color: white; font-size: 2.2rem; font-weight: 800; margin-bottom: 1rem; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: slideUp 0.8s ease-out 0.5s both; background: linear-gradient(45deg, #fff, #eee); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; position: relative; z-index: 1; }
        .splash-subtitle { color: rgba(255,255,255,0.9); font-size: 1.1rem; text-align: center; animation: fadeIn 1s ease-out 1s both; position: relative; z-index: 1; }
        .splash-screen.fade-out { opacity: 0; pointer-events: none; transform: scale(1.1); }

        /* Animations */
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes logoEntrance { 0% { transform: scale(0) rotateY(180deg); opacity: 0; } 100% { transform: scale(1) rotateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(255,255,255,0.3); } 50% { transform: scale(1.05); box-shadow: 0 0 50px rgba(255,255,255,0.5); } }
        @keyframes moveStripes { 0% { background-position: 0 0; } 100% { background-position: 60px 60px; } }
        @keyframes slideUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        /* Background */
        .animated-background { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f8f9fe; z-index: -1; }
        .animated-circles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 1; }
        .animated-circle { position: absolute; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); border-radius: 50%; opacity: 0.05; animation: moveCircle 25s linear infinite alternate; }
        .circle1 { width: 400px; height: 400px; top: -200px; left: -150px; animation-duration: 30s; }
        .circle2 { width: 300px; height: 300px; bottom: -100px; right: -150px; animation-delay: -5s; animation-duration: 35s; }
        .circle3 { width: 200px; height: 200px; top: 50%; left: 20%; animation-delay: -10s; animation-duration: 20s; }
        @keyframes moveCircle { 0% { transform: translate(0, 0) rotate(0deg) scale(1); } 100% { transform: translate(50px, -50px) rotate(180deg) scale(1.2); } }

        /* Utility Buttons */
         .action-button { background: var(--primary-color); color: white; border: none; padding: 0.6rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s ease; margin-top: 1rem; width: auto; display: inline-block; }
         .action-button:hover { background: var(--primary-hover); }

        /* Settings Page */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .setting-card { background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius); padding: 1.5rem 2rem; text-align: center; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; border: 1px solid rgba(99, 102, 241, 0.1); backdrop-filter: blur(8px); box-shadow: var(--shadow-sm); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 150px; }
        .setting-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--primary-color); }
        .setting-card i { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 1rem; }
        .setting-card h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-color); }
        .setting-card p { color: #666; font-size: 0.9rem; line-height: 1.4; }

        /* Home Page Dashboard Styles */
        .home-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--surface-color); border-radius: var(--border-radius); padding: 1.5rem; text-align: center; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--primary-color); }
        .kpi-card .icon { font-size: 2rem; margin-bottom: 0.75rem; display: block; color: var(--primary-color); }
        .kpi-card .title { font-size: 0.9rem; color: #666; margin-bottom: 0.5rem; font-weight: 600; }
        .kpi-card .value { font-size: 2.2rem; font-weight: 700; color: var(--text-color); line-height: 1.1; }
        .kpi-card .unit { font-size: 0.9rem; font-weight: normal; margin-right: 4px; color: #777; }
        .kpi-card.outstanding .icon, .kpi-card.outstanding .value { color: #dc3545; }
        .kpi-card.arrears-count .icon, .kpi-card.arrears-count .value { color: #e74c3c; }
        .kpi-card.collected .icon, .kpi-card.collected .value { color: #198754; }
        .kpi-card.rate .icon, .kpi-card.rate .value { color: var(--primary-hover); }

        .top-arrears-card { background: #fffcf0; border: 1px solid #ffeeba; border-radius: var(--border-radius); padding: 1.5rem 2rem; box-shadow: var(--shadow); }
        .top-arrears-card h2 { color: #856404; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.4rem; border-bottom: 2px solid #ffeeba; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .top-arrears-card h2 i { margin-left: 10px; }
        .top-arrears-list { list-style: none; padding: 0; margin: 0 0 1.5rem 0; }
        .top-arrears-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 0; border-bottom: 1px dashed #ffeeba; font-size: 1rem; }
        .top-arrears-list li:last-child { border-bottom: none; }
        .top-arrears-list .student-info { display: flex; flex-direction: column; align-items: flex-start; gap: 0.1rem; cursor: pointer; }
        .top-arrears-list .student-info .group-name { font-size: 0.8em; color: #666; }
        .top-arrears-list .student-info:hover .student-name { color: var(--primary-hover); }
        .top-arrears-list .amount { font-weight: bold; color: #dc3545; font-size: 1.1em; }
        .view-all-link { display: inline-block; margin-top: 1rem; color: var(--primary-hover); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
        .view-all-link i { margin-right: 5px; }
        .view-all-link:hover { text-decoration: underline; }

        /* Schedule Styles */
        .schedule-section {
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition-base);
        }

        .lessons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 0.25rem;
        }

        .lesson {
            background: rgba(255, 255, 255, 0.85);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            transform-style: preserve-3d;
            transform: perspective(1000px);
            transition: transform 0.3s ease;
            padding: 1rem;
            cursor: pointer;
        }

        .lesson.past { background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.2)); }
        .lesson.upcoming { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.2)); }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .lesson-time { font-size: 1.2rem; font-weight: bold; }
        .lesson-status { font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 1rem; }

        .lesson {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .lesson:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow: auto;
        }

        .modal-content {
            background: var(--surface-color);
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: center;
            color: var(--primary-color);
        }

        .modal-details {
            font-size: 1rem;
            color: var(--text-color);
        }

        /* Attendance Details Table */
        .attendance-details table {
            border-collapse: collapse;
            margin-top: 0.5rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .attendance-details th,
        .attendance-details td {
            padding: 0.4rem;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .attendance-details th {
            background: var(--primary-color);
            color: white;
            font-weight: normal;
        }

        .period-summary {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        /* Current Group Styles */
        .current-group-card {
            background: var(--surface-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            grid-column: 1 / -1;
        }

        .current-group-card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-group-card.empty {
            text-align: center;
            color: #666;
            padding: 2rem;
        }

        .current-students-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .student-attendance-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .attendance-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .attendance-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .lessons-counter {
            background: var(--primary-color);
            color: white;
            padding: 0rem 0rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        /* إضافة الأنماط الداخلية الجديدة */
        .text-center {
            text-align: center;
        }

        .margin-bottom-2 {
            margin-bottom: 2rem;
        }

        .margin-bottom-1 {
            margin-bottom: 1rem;
        }

        .color-gray {
            color: #555;
        }

        .icon-container img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .stats-title {
            color: var(--primary-hover);
        }

        .bullet-list {
            line-height: 1.8;
            padding-right: 20px;
        }

        .list-icon {
            margin-left: 8px;
        }

        .icon-success {
            color: #28a745;
        }

        .icon-danger {
            color: #dc3545;
        }

        .icon-primary {
            color: var(--primary-color);
        }

        .font-bold {
            font-weight: bold;
        }

        .text-danger {
            color: #dc3545;
        }

        .grid-full {
            grid-column: 1 / -1;
        }

        .pointer-events-none {
            pointer-events: none;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .settings-title {
            margin: 0;
        }

        .about-container {
            text-align: center;
            margin-bottom: 2rem;
        }

        .about-logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .about-title {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .about-version {
            color: #555;
        }

        .footer-credit {
            text-align: center;
            margin-top: 2rem;
            color: #777;
        }

        .empty-box-icon {
            font-size: 2rem;
            color: #ccc;
            margin-bottom: 1rem;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <button class="nav-item active" onclick="navigateToMainPage()">
            <i class="fas fa-tachometer-alt"></i>
            <span>الرئيسية</span>
        </button>
        <button class="nav-item" onclick="showGroups()">
            <i class="fas fa-users"></i>
            <span>المجموعات</span>
        </button>
        <button class="nav-item" onclick="showStatistics()">
            <i class="fas fa-chart-bar"></i>
            <span>الإحصائيات</span>
        </button>
        <button class="nav-item" onclick="window.location.href='schedule.html'">
            <i class="fas fa-calendar-alt"></i>
            <span>المواعيد</span>
        </button>
        <button class="nav-item" onclick="showSettings()">
            <i class="fas fa-cog"></i>
            <span>الإعدادات</span>
        </button>
    </nav>

    <!-- Splash Screen -->
    <div class="splash-screen">
        <div class="splash-logo">
            <img src="logo.jpg" alt="أيقونة التطبيق" id="appIcon">
        </div>
        <h1 class="splash-title">مرافق المعلم</h1>
        <p class="splash-subtitle">جاري تحميل النظام...</p>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status"></div>

    <!-- Animated Background -->
    <div class="animated-background">
        <div class="animated-circles">
            <div class="animated-circle circle1"></div>
            <div class="animated-circle circle2"></div>
            <div class="animated-circle circle3"></div>
        </div>
    </div>

    <!-- Main Application Wrapper -->
    <div id="appContainer">

        <!-- Main Content Area (Dynamically Updated) -->
        <div id="mainContentContainer">
             <h1>جاري التحميل...</h1>
        </div>

        <!-- Footer -->
        <footer class="copyright">
            جميع الحقوق محفوظة © 2024 - الأستاذ يوسف الزغبي
        </footer>

    </div> <!-- End of #appContainer -->

    <script>
        // Global flag for online status
        let isOnline = navigator.onLine;

        // --- Function to update active navigation item ---
        function updateActiveNavItem(activeViewFunction) {
            const navItems = document.querySelectorAll('.top-nav .nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                const onclickAttr = item.getAttribute('onclick') || '';
                 const funcNameMatch = onclickAttr.match(/(\w+)\(\)/);
                 if (funcNameMatch && funcNameMatch[1] === activeViewFunction) {
                     item.classList.add('active');
                 }
                 else if (activeViewFunction === 'schedule.html' && onclickAttr.includes('schedule.html')) {
                      item.classList.add('active');
                 }
            });
            window.scrollTo(0, 0);
            // console.log("Active nav set for:", activeViewFunction); // Debug log
        }

        // --- Make helper functions globally available ---
        // (These functions are called via onclick attributes in dynamically loaded HTML)
        window.toggleStudentDetails = function(index, cardIdPrefix = 'student') {
            // console.log(`Toggling details for ${cardIdPrefix}-${index}`); // Debug log
            const details = document.getElementById(`student-details-${index}`);
            const card = document.getElementById(`${cardIdPrefix}-${index}`);
            if (!details || !card) return;
            const isShowing = details.classList.contains('show');
            document.querySelectorAll('.student-details.show').forEach(el => {
                if (el !== details) {
                    el.classList.remove('show');
                    el.closest('.student-card')?.classList.remove('active');
                }
            });
            details.classList.toggle('show', !isShowing);
            card.classList.toggle('active', !isShowing);
        };

        window.toggleSearchDetails = function(index, cardIdPrefix = 'student') {
             // console.log(`Toggling search details for ${cardIdPrefix}-${index}`); // Debug log
             const details = document.getElementById(`search-details-${index}`);
             const card = document.getElementById(`${cardIdPrefix}-${index}`);
             if (!details || !card) return;
             const isShowing = details.classList.contains('show');
             document.querySelectorAll('.student-details.show').forEach(el => {
                 if (el !== details) {
                     el.classList.remove('show');
                     el.closest('.student-card')?.classList.remove('active');
                 }
             });
             details.classList.toggle('show', !isShowing);
             card.classList.toggle('active', !isShowing);
        };

        window.loadGroupByName = function(groupName) {
             // console.log("Loading group by name:", groupName); // Debug log
             for(let i=1;i<=30;i++){ const gds=localStorage.getItem(`group${i}`); if(gds){ try{const gd=JSON.parse(gds); if(gd&&gd.groupName===groupName){loadGroup(i);return}}catch(e){continue}}} alert(`لم تجد المجموعة "${groupName}"`);
        };

        window.toggleGroupDetails = function(groupNumber) {
            // console.log("Toggling group details card:", groupNumber); // Debug log
            const card = document.getElementById(`group-card-${groupNumber}`);
            if (card) card.classList.toggle('expanded');
        };
        // loadGroup is already global

        // --- Function to load views ---
        function loadViewContent(title, contentHTML) {
            // console.log("Loading view:", title); // Debug log
            const mainContent = document.getElementById('mainContentContainer');
            if (!mainContent) { console.error('Error: mainContentContainer not found!'); return; }
            mainContent.innerHTML = `<h1>${title}</h1>` + contentHTML;
            if (mainContent.querySelector('#searchInput')) { initializeSearch(); }
             // Helpers are now globally attached, no need to re-attach here.
            // console.log("Content set for:", title); // Debug log
        }

        // --- Calculation for Home Page Dashboard ---
        function calculateHomePageStats() {
            // console.log("Calculating home page stats..."); // Debug log
            const stats = { totalStudents: 0, totalGroups: 0, totalCollected: 0, totalExpected: 0, totalOutstanding: 0, collectionRate: 0, studentsWithArrearsCount: 0, topUnpaidStudents: [] };
            let groupsFound = 0;
            const unpaidStudentsList = [];
            for (let i = 1; i <= 30; i++) {
                const groupDataStr = localStorage.getItem(`group${i}`);
                if (!groupDataStr) continue;
                try {
                    const groupData = JSON.parse(groupDataStr);
                    if (!groupData || !groupData.students) continue;
                    groupsFound++;
                    stats.totalStudents += groupData.students.length;
                    const groupName = groupData.groupName || `المجموعة ${i}`;
                    groupData.students.forEach((student) => {
                        if (!student) return;
                        const monthlyPayment = student.monthlyPayment || 150;
                        const payments = student.payments || [];
                        const studentTotalPaid = payments.reduce((sum, p) => sum + (Number(p) || 0), 0);
                        let studentCountedLessons = 0;
                        (student.attendance || []).forEach(att => { if (att && att[0]) studentCountedLessons++; });
                        const completePeriods = Math.floor(studentCountedLessons / 8);
                        const studentTotalExpected = completePeriods * monthlyPayment;
                        const studentUnpaidAmount = Math.max(0, studentTotalExpected - studentTotalPaid);
                        stats.totalCollected += studentTotalPaid;
                        stats.totalExpected += studentTotalExpected;
                        if (studentUnpaidAmount > 0) {
                            unpaidStudentsList.push({ name: student.name || 'طالب بدون اسم', groupName: groupName, groupNumber: i, unpaidAmount: studentUnpaidAmount });
                        }
                    });
                } catch (e) { console.error(`Error calculating stats for group ${i} on home page:`, e); }
            }
            stats.totalGroups = groupsFound;
            stats.totalOutstanding = Math.max(0, stats.totalExpected - stats.totalCollected);
            stats.collectionRate = stats.totalExpected > 0 ? Math.round((stats.totalCollected / stats.totalExpected) * 100) : 100;
            stats.studentsWithArrearsCount = unpaidStudentsList.length;
            unpaidStudentsList.sort((a, b) => b.unpaidAmount - a.unpaidAmount);
            stats.topUnpaidStudents = unpaidStudentsList.slice(0, 5);
            stats.totalCollected = Number(stats.totalCollected.toFixed(2));
            stats.totalExpected = Number(stats.totalExpected.toFixed(2));
            stats.totalOutstanding = Number(stats.totalOutstanding.toFixed(2));
            // console.log("Home page stats calculated:", stats); // Debug log
            return stats;
        }

        // --- Renderer for Home Page Dashboard ---
        function renderHomePageHTML() {
            const stats = calculateHomePageStats();
            const currentGroupStudents = getCurrentGroupStudents();

            const currentGroupHTML = currentGroupStudents ? `
                <div class="current-group-card">
                    <h3><i class="fas fa-users"></i> ${currentGroupStudents.groupName}</h3>
                    <div class="current-students-list">
                        ${currentGroupStudents.students.map((student, idx) => {
                            const lessonCount = calculateCurrentLesson(student);
                            const isChecked = isStudentAttendedToday(student);
                            return `
                                <div class="student-attendance-row">
                                    <label class="attendance-checkbox">
                                        <input type="checkbox"
                                            ${isChecked ? 'checked' : ''}
                                            onchange="handleQuickAttendance(${currentGroupStudents.groupNumber}, ${idx}, this.checked)">
                                        <span class="student-name">${student.name || 'طالب بدون اسم'}</span>
                                    </label>
                                    <span class="lessons-counter${lessonCount.current === 8 ? ' warning' : ''}" 
                                          title="الدورة ${lessonCount.period}">
                                        ${lessonCount.current}/8
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : `
                <div class="current-group-card empty">
                    <p><i class="fas fa-clock"></i> لا توجد مجموعة حالية</p>
                </div>
            `;

            return `
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ابحث عن اسم الطالب..." autocomplete="off">
                        <button onclick="showSearchPage(document.getElementById('searchInput').value.trim())">
                            <i class="fas fa-search"></i><span>بحث</span>
                        </button>
                    </div>
                </div>
                <div class="home-stats-grid">
                    ${currentGroupHTML}
                    <div class="kpi-card collected">
                        <i class="fas fa-coins icon"></i>
                        <div class="title">إجمالي المحصل</div>
                        <div class="value">${stats.totalCollected}<span class="unit">ج</span></div>
                    </div>
                    <div class="kpi-card outstanding ${stats.totalOutstanding > 0 ? 'has-outstanding' : ''}">
                        <i class="fas fa-exclamation-triangle icon"></i>
                        <div class="title">إجمالي المتأخرات</div>
                        <div class="value">${stats.totalOutstanding}<span class="unit">ج</span></div>
                    </div>
                </div>
                ${stats.topUnpaidStudents.length > 0 ? `
                    <div class="top-arrears-card">
                        <h2><i class="fas fa-exclamation-triangle"></i> أبرز الطلاب المتأخرين</h2>
                        <ul class="top-arrears-list">
                            ${stats.topUnpaidStudents.map(student => `
                                <li>
                                    <div class="student-info" onclick="loadGroup(${student.groupNumber})">
                                        <span class="student-name">${student.name}</span>
                                        <span class="group-name">${student.groupName}</span>
                                    </div>
                                    <span class="amount">${student.unpaidAmount} ج</span>
                                </li>`).join('')}
                        </ul>
                        <a href="#" onclick="event.preventDefault(); showStatistics();" class="view-all-link">
                            <i class="fas fa-list-ul"></i> عرض كل الطلاب المتأخرين...
                        </a>
                    </div>` : ''}
            `;
        }

        function getCurrentGroupStudents() {
            const now = new Date();
            const today = now.getDay();
            const currentTime = now.getHours() * 60 + now.getMinutes();

            for (let i = 1; i <= 30; i++) {
                const groupData = JSON.parse(localStorage.getItem(`group${i}`));
                if (!groupData) continue;

                const day1 = parseInt(localStorage.getItem(`day1-${i}`));
                const day2 = parseInt(localStorage.getItem(`day2-${i}`));
                const time1 = localStorage.getItem(`time1-${i}`);
                const time2 = localStorage.getItem(`time2-${i}`);

                if (day1 === today || day2 === today) {
                    const time = day1 === today ? time1 : time2;
                    if (!time) continue;

                    const [hours, minutes] = time.split(':').map(Number);
                    const lessonTime = hours * 60 + minutes;

                    // Check if we're within 45 minutes of the lesson time
                    if (Math.abs(currentTime - lessonTime) <= 45) {
                        return {
                            groupNumber: i,
                            groupName: groupData.groupName || `المجموعة ${i}`,
                            students: groupData.students || [],
                            lessonTime: time
                        };
                    }
                }
            }
            return null;
        }

        function countStudentLessons(student) {
            if (!student.attendance) return { current: 0, total: 0 };

            // حساب بداية الفترة الحالية
            const periodSize = 8;
            const totalPeriods = Math.ceil(student.attendance.length / periodSize);
            const currentPeriodIndex = totalPeriods - 1;
            const currentPeriodStart = currentPeriodIndex * periodSize;

            let currentPeriodLessons = 0;
            let totalLessons = 0;

            student.attendance.forEach((att, idx) => {
                if (att && att[0]) {
                    totalLessons++;
                    if (idx >= currentPeriodStart) {
                        currentPeriodLessons++;
                    }
                }
            });

            return {
                current: currentPeriodLessons,
                total: 8,
                currentPeriodStart: currentPeriodStart
            };
        }

        function isStudentAttendedToday(student) {
            if (!student.attendance || student.attendance.length === 0) return false;

            const today = new Date().toISOString().split('T')[0];
            const lastAttendanceIdx = student.attendance.length - 1;

            // Check if the last attendance entry is from today
            if (lastAttendanceIdx >= 0) {
                return student.attendance[lastAttendanceIdx][0] && student.attendance[lastAttendanceIdx][1];
            }
            return false;
        }

        function handleQuickAttendance(groupNumber, studentIndex, isChecked) {
            const groupData = JSON.parse(localStorage.getItem(`group${groupNumber}`));
            if (!groupData || !groupData.students || !groupData.students[studentIndex]) return;

            const today = new Date().toISOString().split('T')[0];
            let dateIndex = groupData.dates.indexOf(today);

            // إذا لم يكن التاريخ موجوداً، أضفه
            if (dateIndex === -1) {
                dateIndex = groupData.dates.findIndex(date => !date);
                if (dateIndex === -1) {
                    // لا توجد مساحة فارغة، نضيف شهراً جديداً
                    const oldLength = groupData.dates.length;
                    addNewMonth(groupNumber);
                    // نقرأ البيانات المحدثة بعد إضافة الشهر
                    const updatedGroupData = JSON.parse(localStorage.getItem(`group${groupNumber}`));
                    groupData.dates = updatedGroupData.dates;
                    groupData.students = updatedGroupData.students;
                    dateIndex = oldLength;
                    groupData.dates[dateIndex] = today;
                } else {
                    groupData.dates[dateIndex] = today;
                }
            }

            // تحديث الحضور
            if (!groupData.students[studentIndex].attendance) {
                groupData.students[studentIndex].attendance = Array(groupData.dates.length).fill([false, false]);
            }

            // حساب عدد الحصص المحتسبة قبل التحديث
            const periodSize = 8;
            const totalPeriods = Math.ceil(groupData.dates.length / periodSize);
            const currentPeriodIndex = totalPeriods - 1;
            const currentPeriodStart = currentPeriodIndex * periodSize;

            let currentPeriodLessons = 0;
            groupData.students[studentIndex].attendance.forEach((att, idx) => {
                if (idx >= currentPeriodStart && att && att[0]) {
                    currentPeriodLessons++;
                }
            });

            // تعيين الحضور والاحتساب معاً
            groupData.students[studentIndex].attendance[dateIndex] = [true, isChecked];

            // حفظ التغييرات
            saveData(`group${groupNumber}`, groupData);

            // تحديث العداد مباشرة في واجهة المستخدم
            const lessonCount = calculateCurrentLesson(groupData.students[studentIndex]);
            const counterElement = document.querySelector(`.current-students-list .student-attendance-row:nth-child(${studentIndex + 1}) .lessons-counter`);
            if (counterElement) {
                counterElement.textContent = `${lessonCount.current}/8`;
                counterElement.title = `الدورة ${lessonCount.period}`;
                counterElement.classList.toggle('warning', lessonCount.current === 8);
                
                // تحريك العداد لجذب الانتباه
                counterElement.style.transform = 'scale(1.2)';
                counterElement.style.color = isChecked ? '#10b981' : '#ef4444';
                setTimeout(() => {
                    counterElement.style.transform = 'scale(1)';
                    counterElement.style.color = 'white';
                }, 300);
            }
        }

        // --- Main Page Navigation ---
        function navigateToMainPage() {
            const homePageHTML = renderHomePageHTML();
            loadViewContent('المعلومات الرئيسية', homePageHTML);
            updateActiveNavItem('navigateToMainPage');
        }

        // --- Show Groups List ---
        function showGroups() {
            // console.log("Showing groups..."); // Debug log
            let allGroups = [];
            for (let i = 1; i <= 30; i++) {
                const groupDataStr = localStorage.getItem(`group${i}`);
                if (groupDataStr) { try { const groupData = JSON.parse(groupDataStr); if (!groupData.students) groupData.students = []; const stats = calculateGroupStats(groupData); allGroups.push({ number: i, ...groupData, stats }); } catch (e) { console.error(`Error parsing group ${i} data:`, e); } }
             }
             const groupsHTML = `
                <div class="buttons-container"> <button onclick="addGroup()"><i class="fas fa-plus"></i> إضافة مجموعة جديدة</button> </div>
                <div class="groups-grid">
                    ${allGroups.length > 0 ? allGroups.map(group => `
                        <div class="group-card" id="group-card-${group.number}" onclick="loadGroup(${group.number})">
                            <h3 onclick="event.stopPropagation(); toggleGroupDetails(${group.number})"> <span>${group.groupName || `المجموعة ${group.number}`}</span> <span class="toggle-details"><i class="fas fa-chevron-down"></i></span> </h3>
                            <div class="group-stats" style="pointer-events: none;">
                                <div class="stat-item"><span>عدد الطلاب</span><strong>${group.students.length}</strong></div> <div class="stat-item"><span>المحصل</span><strong>${group.stats.collected} ج</strong></div>
                                <div class="stat-item"><span>المتأخرات</span><strong style="color:${group.stats.remaining > 0 ? '#dc3545' : '#198754'}">${group.stats.remaining} ج</strong></div> <div class="stat-item"><span>الحضور</span><strong>${group.stats.attendanceRate}%</strong></div>
                            </div>
                            <div class="group-details"> <div class="group-students"> <h4>الطلاب (${group.students.length}):</h4> <ul class="student-list">${group.students.length > 0 ? group.students.map(s => `<li>${s.name || 'طالب بدون اسم'}</li>`).join('') : '<li style="text-align:center; color:#888;">لا يوجد طلاب</li>'}</ul> </div> </div>
                        </div>`).join('') : '<div class="grid-full"><i class="fas fa-box-open empty-box-icon"></i><p>لا توجد مجموعات حالياً.</p></div>'}
                </div>`;
            loadViewContent('المجموعات الدراسية', groupsHTML);
            updateActiveNavItem('showGroups');
        }

        // --- Load Individual Group Table ---
        function loadGroup(groupNumber) {
            // console.log("Loading group:", groupNumber); // Debug log
            let groupData;
            try {
                groupData = JSON.parse(localStorage.getItem(`group${groupNumber}`)) || { students: [], dates: Array(8).fill(''), groupName: `المجموعة ${groupNumber}` };
                if (!groupData.students) groupData.students = [];
                if (!groupData.dates || groupData.dates.length === 0) groupData.dates = Array(8).fill('');
                groupData.students.forEach(s => {
                     if (!s.attendance || s.attendance.length !== groupData.dates.length) { const newA = Array(groupData.dates.length).fill([false,false]); if(s.attendance) for(let i=0; i<Math.min(s.attendance.length, newA.length); i++) newA[i]=s.attendance[i]; s.attendance = newA; }
                     const expectedP = Math.ceil(groupData.dates.length / 8);
                     if (!s.payments || s.payments.length !== expectedP) { const newP = Array(expectedP).fill(0); if(s.payments) for(let i=0; i<Math.min(s.payments.length, newP.length); i++) newP[i]=s.payments[i]; s.payments = newP; }
                 });
            } catch (e) { console.error(`Error loading group ${groupNumber}:`, e); alert(`حدث خطأ تحميل المجموعة ${groupNumber}.`); showGroups(); return; }
            const numMonths = Math.ceil(groupData.dates.length / 8);
            const contentHTML = `
                 <button onclick="showGroups()" class="back-button"><i class="fas fa-arrow-right"></i> العودة للمجموعات</button>
                <div class="buttons-container">
                    <button onclick="changeGroupName(${groupNumber})"><i class="fas fa-edit"></i> تغيير الاسم</button> <button onclick="addStudent(${groupNumber})"><i class="fas fa-user-plus"></i> إضافة طالب</button>
                    <button onclick="addNewMonth(${groupNumber})"><i class="fas fa-calendar-plus"></i> إضافة شهر</button> <button onclick="exportToExcel(${groupNumber})"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                    <input type="file" id="importFile" onchange="importFromExcel(${groupNumber})" accept=".xlsx" style="display: none;">
                    <button onclick="document.getElementById('importFile').click()"><i class="fas fa-file-upload"></i> استيراد Excel</button> <button onclick="deleteGroup(${groupNumber})" class="delete-button"><i class="fas fa-trash-alt"></i> حذف المجموعة</button>
                </div>
                <div class="table-container">
                    <table id="attendanceTable">
                         <thead>
                            <tr>
                                <th rowspan="2" style="min-width: 100px; padding: 10px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; font-size: 0.9rem;">اسم الطالب</th>
                                <th rowspan="2" style="min-width: 70px; padding: 10px; background: #f8f9fa;">قيمة السداد</th>
                                ${Array.from({ length: numMonths }).map((_, mIdx) => `<th colspan="8" style="padding: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white;">الشهر ${mIdx + 1}<div class="month-actions">${groupData.dates.length > 8 ? `<span class="action-icon delete-month" title="حذف الشهر ${mIdx + 1}" onclick="deleteMonth(${groupNumber}, ${mIdx})">×</span>` : ''}</div></th><th style="padding: 10px; background: #28a745; color: white;">سداد ${mIdx + 1}</th>`).join('')}
                                <th rowspan="2" style="min-width: 100px; padding: 10px; background: linear-gradient(135deg, #dc3545, #c0392b); color: white;">المتأخرات</th>
                            </tr>
                            <tr>
                                ${groupData.dates.map((date, index) => `
                                    <th style="min-width: 50px; padding: 8px 4px; background: #f8f9fa;">
                                        <div style="font-size: 0.8rem; font-weight: 600; color: var(--primary-color); margin-bottom: 4px;">حصّة ${ (index % 8) + 1}</div>
                                        <input type="date"
                                            value="${date || ''}"
                                            onchange="updateDate(${groupNumber}, ${index}, this.value)"
                                            class="lesson-date-input"
                                            title="${date || 'اختر التاريخ'}"
                                            data-date="${date || ''}"
                                            onclick="try { this.showPicker() } catch(e) {}"
                                            style="padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.75rem;">
                                    </th>
                                    ${(index + 1) % 8 === 0 ? `<th style="min-width: 70px; padding: 8px; background: rgba(40, 167, 69, 0.1); color: #28a745; font-weight: 600;">المبلغ</th>` : ''}`
                                ).join('')}
                            </tr>
                        </thead>
                        <tbody>
                             ${groupData.students.length === 0 ? `<tr><td colspan="${2 + (numMonths * 9) + 1}" style="text-align: center; padding: 2rem; color: #888;"><i class="fas fa-user-slash" style="font-size: 1.5rem; display:block; margin-bottom: 0.5rem;"></i>لا يوجد طلاب.</td></tr>` : ''}
                            ${groupData.students.map((student, sIdx) => {
                                const lessonCount = calculateCurrentLesson(student);
                                return `
                                <tr id="student-row-${groupNumber}-${sIdx}">
                                    <td style="min-width: 100px; padding: 3px;">
                                        <div style="display: flex; flex-direction: column; gap: 3px;">
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <span class="lesson-counter${lessonCount.current === 8 ? ' warning' : ''}"
                                                      title="الدورة ${lessonCount.period}"
                                                      style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 1px 5px; border-radius: 10px; font-size: 0.65rem; font-weight: bold; white-space: nowrap;">${lessonCount.current}/8</span>
                                                <input type="text" value="${student.name || ''}"
                                                    onchange="updateStudentName(${groupNumber}, ${sIdx}, this.value)"
                                                    style="flex: 1; padding: 3px 5px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.75rem; min-width: 0;">
                                            </div>
                                            <button onclick="deleteStudent(${groupNumber}, ${sIdx})"
                                                class="delete-student"
                                                style="padding: 2px 5px; font-size: 0.65rem; border-radius: 3px;"
                                                title="حذف ${student.name || ''}">
                                                <i class="fas fa-trash-alt" style="margin-left: 2px;"></i>حذف
                                            </button>
                                        </div>
                                    </td>
                                    <td style="min-width: 60px; padding: 6px;">
                                        <input type="number"
                                            class="monthly-payment-input"
                                            value="${student.monthlyPayment || 150}"
                                            onchange="updateMonthlyPayment(${groupNumber}, ${sIdx}, this.value)"
                                            min="0"
                                            style="width: 100%; padding: 6px 4px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; text-align: center;">
                                    </td>
                                    ${student.attendance.map((att, i) => {
                                        const aCkd = att && att[1] ? 'checked' : '';
                                        const cCkd = att && att[0] ? 'checked' : '';
                                        const aDis = !(att && att[0]);
                                        const pVal = student.payments?.[Math.floor(i/8)] ?? 0;
                                        return `
                                            <td style="min-width: 40px; text-align: center; padding: 4px; vertical-align: middle;">
                                                <div style="display: flex; align-items: center; justify-content: center; gap: 3px;">
                                                    <input type="checkbox"
                                                        title="محتسبة؟"
                                                        ${cCkd}
                                                        onchange="updateAttendance(${groupNumber}, ${sIdx}, ${i}, 0, this.checked)"
                                                        style="width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary-color);">
                                                    <input type="checkbox"
                                                        title="حضر؟"
                                                        ${aCkd}
                                                        onchange="updateAttendance(${groupNumber}, ${sIdx}, ${i}, 1, this.checked)"
                                                        ${aDis ? 'disabled' : ''}
                                                        style="width: 16px; height: 16px; cursor: ${aDis ? 'not-allowed' : 'pointer'}; opacity: ${aDis ? 0.4 : 1}; accent-color: #28a745;">
                                                </div>
                                            </td>
                                            ${(i + 1) % 8 === 0 ?
                                                `<td style="min-width: 60px; padding: 4px;">
                                                    <input type="number"
                                                        value="${pVal}"
                                                        onchange="updatePayment(${groupNumber}, ${sIdx}, ${Math.floor(i/8)}, this.value)"
                                                        style="width: 100%; padding: 4px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 0.85rem; text-align: center;"
                                                        min="0">
                                                </td>` :
                                                ''}`;
                                    }).join('')}
                                    <td style="min-width: 90px; text-align: center; padding: 8px; vertical-align: middle;">
                                        <div style="display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; padding: 6px 10px; border-radius: 8px; background: ${(() => {
                                            const mp = student.monthlyPayment || 150;
                                            const ps = student.payments || [];
                                            const totalPaid = ps.reduce((sum, p) => sum + (Number(p) || 0), 0);
                                            let sc = 0;
                                            (student.attendance || []).forEach(att => { if (att && att[0]) sc++; });
                                            const cp = Math.floor(sc / 8);
                                            const expected = cp * mp;
                                            const arrears = Math.max(0, expected - totalPaid);
                                            return arrears > 0 ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)';
                                        })()}; color: ${(() => {
                                            const mp = student.monthlyPayment || 150;
                                            const ps = student.payments || [];
                                            const totalPaid = ps.reduce((sum, p) => sum + (Number(p) || 0), 0);
                                            let sc = 0;
                                            (student.attendance || []).forEach(att => { if (att && att[0]) sc++; });
                                            const cp = Math.floor(sc / 8);
                                            const expected = cp * mp;
                                            const arrears = Math.max(0, expected - totalPaid);
                                            return arrears > 0 ? '#dc3545' : '#28a745';
                                        })()};">
                                            ${(() => {
                                                const mp = student.monthlyPayment || 150;
                                                const ps = student.payments || [];
                                                const totalPaid = ps.reduce((sum, p) => sum + (Number(p) || 0), 0);
                                                let sc = 0;
                                                (student.attendance || []).forEach(att => { if (att && att[0]) sc++; });
                                                const cp = Math.floor(sc / 8);
                                                const expected = cp * mp;
                                                const arrears = Math.max(0, expected - totalPaid);
                                                return arrears > 0 ? arrears + ' ج' : '<i class="fas fa-check-circle"></i>';
                                            })()}
                                        </div>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>`;
            loadViewContent(groupData.groupName || `المجموعة ${groupNumber}`, contentHTML);
            updateActiveNavItem('showGroups'); // Keep groups active when viewing a group
        }

        // Add new helper function to calculate current lesson
        function calculateCurrentLesson(student) {
            if (!student.attendance) return { current: 0, period: 1 };

            let totalCounted = 0;
            student.attendance.forEach(att => {
                if (att && att[0]) totalCounted++;
            });

            const period = Math.floor(totalCounted / 8) + 1;
            const current = (totalCounted % 8); // Changed from || 8 to handle 0 correctly

            return { current: current === 0 && totalCounted > 0 ? 8 : current, period };
        }

        // --- Renderer for the Full Statistics Page ---
        function renderFullStatisticsHTML() {
            const stats = calculateAllStatistics();
            if (!stats) {
                console.error("Failed to calculate full statistics.");
                return `<div class="stats-card"><p>حدث خطأ أثناء حساب الإحصائيات.</p></div>`;
            }
            const activeGroupStats = stats.groupStats.filter(g => g.collected > 0 || g.expected > 0 || g.remaining !== 0);
            stats.unpaidStudents.sort((a, b) => b.unpaidAmount - a.unpaidAmount);

            const unpaidStudentsHTML = stats.unpaidStudents.length > 0 ? `
                <div class="stats-card" style="background-color: #fff3cd; border-color: #ffeeba;">
                    <h2 style="color: #856404;"><i class="fas fa-exclamation-triangle"></i> طلاب متأخرون (${stats.unpaidStudents.length})</h2>
                    <div class="students-grid">
                        ${stats.unpaidStudents.map((student, index) => `
                            <div class="student-card" id="unpaid-student-${index}">
                                <div class="student-name" onclick="toggleStudentDetails(${index}, 'unpaid-student')"> <span>${student.name}</span> <span class="badge">${student.unpaidAmount} ج</span> </div>
                                <div> <span class="group-badge" style="cursor: pointer;" onclick="loadGroup(${student.groupNumber});">${student.groupName}</span> <span style="font-size: 0.9em; color: #555; margin-right: 5px;">(${student.monthsOverdue} فترة)</span> </div>
                                <div id="student-details-${index}" class="student-details">
                                    <div><strong>المطلوب شهرياً:</strong> ${student.expectedPerMonth} ج</div>
                                    <div><strong>المدفوع:</strong> ${student.totalPaid} ج</div>
                                    <div><strong>المطلوب:</strong> ${student.totalDue} ج</div>
                                    <div class="month-details">
                                        ${(() => {
                                            const periods = [];
                                            const numPeriods = Math.ceil((student.attendanceDetails || []).length / 8);

                                            for(let p = 0; p < numPeriods; p++) {
                                                // تحديد بداية ونهاية الفترة الحالية
                                                const pStart = p * 8;
                                                const periodDetails = (student.attendanceDetails || []).slice(pStart, pStart + 8);

                                                // حساب إحصائيات الفترة
                                                const counted = periodDetails.reduce((sum, d) => sum + (d?.countedLessons || 0), 0);
                                                const attended = periodDetails.reduce((sum, d) => sum + (d?.attendedLessons || 0), 0);

                                                // حساب المبلغ المتوقع بناءً على عدد الحصص المحتسبة
                                                const expectedAmount = counted === 8 ?
                                                    student.expectedPerMonth :
                                                    Math.round((counted / 8) * student.expectedPerMonth);

                                                // العثور على أول وآخر تاريخ في الفترة (إن وجد)
                                                const firstDate = periodDetails.find(d => d?.date)?.date || '';
                                                const lastDate = [...periodDetails].reverse().find(d => d?.date)?.date || '';

                                                const payment = student.payments?.[p] || 0;

                                                periods.push(`
                                                    <div class="month-item">
                                                        <strong>الفترة ${p + 1}</strong>
                                                        <div>الحضور: ${attended}/${counted}</div>
                                                        <div style="color:${counted === 8 ? '#198754' : '#666'}">
                                                            الحصص: ${counted}/8
                                                        </div>
                                                        <div style="color:${payment >= expectedAmount ? '#198754' : '#dc3545'}">
                                                            المدفوع: ${payment}/${expectedAmount} ج
                                                            ${counted < 8 && counted > 0 ?
                                                                `<small style="display:block;font-size:0.8em;color:#666">
                                                                    (${Math.round((counted/8)*100)}% من الفترة)
                                                                </small>` :
                                                                ''}
                                                        </div>
                                                        ${firstDate ? `
                                                            <div style="font-size:0.9em;color:#666;margin-top:0.5rem;">
                                                                من: ${firstDate}
                                                                ${lastDate && lastDate !== firstDate ? `<br>إلى: ${lastDate}` : ''}
                                                            </div>` : ''}
                                                    </div>`
                                                );
                                            }
                                            return periods.join('');
                                        })()}
                                    </div>
                                    <button onclick="loadGroup(${student.groupNumber}); event.stopPropagation();" class="action-button">
                                        <i class="fas fa-eye"></i> عرض
                                    </button>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>` : '';

            const groupStatsHTML = activeGroupStats.length > 0 ? `
                <div class="table-container" style="margin: 0 -1.5rem;"><table style="margin-top: 0;"><thead><tr><th>المجموعة</th><th>المحصل</th><th>المتوقع</th><th>المتبقي</th><th>التحصيل</th><th>إجراء</th></tr></thead><tbody>
                ${activeGroupStats.map(g => `<tr><td>${g.name}</td><td>${g.collected} ج</td><td>${g.expected} ج</td><td style="color: ${g.remaining > 0 ? '#dc3545' : '#198754'}">${g.remaining} ج</td><td>${g.expected > 0 ? Math.round((g.collected / g.expected) * 100) : 100}%</td><td><button onclick="loadGroupByName('${g.name}')" style="padding: 0.3rem 0.6rem; font-size: 0.8em; background: var(--primary-color);">فتح</button></td></tr>`).join('')}
                </tbody></table></div>` : '<div style="text-align: center; padding: 1rem; color: #888;">لا توجد إحصائيات للمجموعات.</div>';

            return `
                ${unpaidStudentsHTML}
                <div class="stats-container">
                    <div class="stats-card">
                        <h2><i class="fas fa-coins"></i> إجمالي المبالغ</h2>
                        <div class="stats-grid"> <div><h3>المحصل</h3><p>${stats.totalCollected} ج</p></div> <div><h3>المتوقع</h3><p>${stats.totalExpected} ج</p></div> <div><h3>المتبقي</h3><p style="color:${stats.totalExpected - stats.totalCollected > 0 ? '#dc3545' : '#198754'}">${stats.totalExpected - stats.totalCollected} ج</p></div> </div>
                    </div>
                    <div class="stats-card">
                        <h2><i class="fas fa-layer-group"></i> إحصائيات المجموعات</h2>
                        ${groupStatsHTML}
                    </div>
                </div>
                <div class="buttons-container"><button onclick="exportStatisticsToExcel()"><i class="fas fa-file-excel"></i> تصدير الإحصائيات Excel</button></div>`;
        }

        // --- Show Statistics (Full Report) ---
        function showStatistics() {
            // console.log("Showing full statistics..."); // Debug log
            const fullStatsHTML = renderFullStatisticsHTML();
            loadViewContent('الإحصائيات العامة', fullStatsHTML);
            updateActiveNavItem('showStatistics');
        }

        // --- Show Search Results Page ---
        function showSearchPage(searchTerm) {
            // إغلاق لوحة المفاتيح على الهواتف المحمولة
            document.activeElement?.blur();

            const searchInputEl = document.getElementById('searchInput');
            const currentCursorPosition = searchInputEl?.selectionStart;
            searchTerm = searchTerm ? searchTerm.trim().toLowerCase() : '';
            if (!searchTerm || searchTerm.length < 2) { const mc = document.getElementById('mainContentContainer'); if (mc.querySelector('.search-results')) { mc.querySelector('.search-results').innerHTML = '<div class="stats-card" style="text-align:center; color:#888;"><i class="fas fa-search"></i><p>أدخل حرفين على الأقل للبحث.</p></div>'; } updateActiveNavItem('navigateToMainPage'); return; }
             let allResults = [];
              for (let i = 1; i <= 30; i++) {
                const gds = localStorage.getItem(`group${i}`); if (!gds) continue;
                try {
                    const gd = JSON.parse(gds); if (!gd || !gd.students) continue;
                    gd.students.forEach((s, sIdx) => {
                        if (s && s.name && s.name.toLowerCase().includes(searchTerm)) {
                            const mp = s.monthlyPayment || 150; const pays = s.payments || []; const tp = pays.reduce((sum, p) => sum + (Number(p) || 0), 0); let cl = 0; (s.attendance || []).forEach(att => { if (att && att[0]) cl++; }); const cp = Math.floor(cl / 8); const te = cp * mp; const oa = Math.max(0, te - tp); let om = 0; for(let p = 0; p < cp; p++){ if((pays[p] || 0) < mp) om++; }
                            allResults.push({
                                name: s.name,
                                groupName: gd.groupName || `المجموعة ${i}`,
                                groupNumber: i,
                                studentIndex: sIdx,
                                monthlyPayment: mp,
                                payments: pays,
                                overdueAmount: oa,
                                overdueMonths: om,
                                totalExpected: te,
                                totalPaid: tp,
                                completePeriods: cp,
                                attendance: s.attendance || [],
                                dates: gd.dates || []
                            });
                        }
                    });
                } catch (e) { console.error(`Error searching group ${i}:`, e); }
            }
            const contentHTML = `
                 <div class="search-container"> <div class="search-box"> <input type="text" id="searchInput" value="${searchTerm}" placeholder="ابحث..." autocomplete="off"> <button onclick="showSearchPage(document.getElementById('searchInput').value.trim())"><i class="fas fa-search"></i><span>بحث</span></button> </div> </div>
                 <div class="search-results">
                     ${allResults.length > 0 ? `<p style="margin-bottom:1rem;font-weight:600;">${allResults.length} نتيجة لـ "${searchTerm}":</p>${allResults.map((r, idx) => `<div class="student-card" id="search-result-${idx}"><div class="student-name" onclick="toggleSearchDetails(${idx}, 'search-result')"><span>${r.name}</span><div><span class="group-badge">${r.groupName}</span> ${r.overdueMonths > 0 ? `<span class="badge">${r.overdueAmount} ج</span>` : `<span class="badge" style="background-color:#198754;">تمام ✓</span>`}</div></div><div id="search-details-${idx}" class="student-details"><div><strong>السداد:</strong> ${r.monthlyPayment} ج</div><div><strong>المطلوب:</strong> ${r.totalExpected} ج</div><div><strong>المدفوع:</strong> ${r.totalPaid} ج</div><div style="font-weight:bold;color:${r.overdueAmount > 0 ? '#dc3545':'#198754'}"><strong>المتأخر:</strong> ${r.overdueAmount} ج</div><hr style="border:0;border-top:1px solid #eee;margin:1rem 0;"><div class="month-details">${(() => { const periods = []; for(let p = 0; p < Math.ceil(r.attendance.length / 8); p++) { const start = p * 8; const end = Math.min(start + 8, r.attendance.length); const periodAtt = r.attendance.slice(start, end); const periodDates = r.dates.slice(start, end); const counted = periodAtt.filter(a => a[0]).length; const attended = periodAtt.filter(a => a[0] && a[1]).length; const attendanceDetails = periodAtt.map((att, idx) => { const date = periodDates[idx] || ''; const status = att[0] ? (att[1] ? 'حضر' : 'غياب') : 'غير محتسبة'; const color = att[0] ? (att[1] ? '#198754' : '#dc3545') : '#666'; return `<tr><td>حصة ${idx + 1}</td><td style="color:${color}">${status}</td><td dir="ltr">${date}</td></tr>`; }).join(''); const expectedAmount = counted === 8 ? r.monthlyPayment : Math.round((counted / 8) * r.monthlyPayment); periods.push(`<div class="month-item"><strong>الفترة ${p + 1}</strong><div class="period-summary"><div>الحضور: ${attended}/${counted}</div><div style="color:${counted === 8 ? '#198754' : '#666'}">الحصص: ${counted}/8</div><div style="color:${(r.payments[p] || 0) >= expectedAmount ? '#198754' : '#dc3545'}">المدفوع: ${r.payments[p] || 0}/${expectedAmount} ج${counted < 8 ? `<small style="display:block;font-size:0.8em;color:#666">(${Math.round((counted/8)*100)}% من الفترة)</small>` : ''}</div></div><div class="attendance-details" style="margin-top:0.5rem;"><table style="width:100%; font-size:0.9em;"><thead><tr><th>الحصة</th><th>الحالة</th><th>التاريخ</th></tr></thead><tbody>${attendanceDetails}</tbody></table></div></div>`); } return periods.join(''); })()}</div><button onclick="loadGroup(${r.groupNumber}); event.stopPropagation();" class="action-button"><i class="fas fa-eye"></i> عرض بالمجموعة</button></div></div>`).join('')}` : `<div class="stats-card" style="text-align:center;color:#888;"><i class="fas fa-frown-open" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;"></i><h2>لا توجد نتائج</h2><p>لم نجد "${searchTerm}".</p></div>`}
                 </div>`;
             loadViewContent(`نتائج البحث: "${searchTerm}"`, contentHTML);
             updateActiveNavItem('navigateToMainPage'); // Keep Home active for search
             const nsi = document.getElementById('searchInput');
             if (nsi) { nsi.focus(); if (typeof currentCursorPosition === 'number') { try { nsi.setSelectionRange(currentCursorPosition, currentCursorPosition); } catch (e) { console.warn("Cursor set failed:", e); } } nsi.addEventListener('keypress', function(e) { if (e.key === 'Enter') { showSearchPage(this.value); } }); }
        }

        // --- Show Settings Page ---
        function showSettings() {
             // console.log("Showing settings..."); // Debug log
             const contentHTML = `
                <p style="text-align: center; color: #555; margin-bottom: 2rem;"> إدارة النسخ الاحتياطي واستعادة البيانات وإعدادات أخرى. </p>
                <div class="settings-grid">
                    <div class="setting-card" onclick="backupLocalStorage()"> <i class="fas fa-download"></i> <h3>حفظ نسخة احتياطية</h3> <p>تصدير كل البيانات لملف JSON آمن.</p> </div>
                    <div class="setting-card" onclick="document.getElementById('restoreInput').click()"> <i class="fas fa-upload"></i> <h3>استعادة نسخة</h3> <p>استيراد بيانات من ملف JSON. <strong style='color:#dc3545;'>سيتم استبدال البيانات الحالية.</strong></p> </div>
                    <div class="setting-card" onclick="showAboutPage()"> <i class="fas fa-info-circle"></i> <h3>عن البرنامج</h3> <p>عرض معلومات البرنامج والمميزات.</p> </div>
                    <div class="setting-card" onclick="clearAllDataWithConfirmation()"> <i class="fas fa-trash-alt" style="color:#dc3545;"></i> <h3 style="color:#dc3545;">مسح كل البيانات</h3> <p>حذف كل المجموعات والمواعيد نهائياً. <strong style='color:#dc3545;'>لا يمكن التراجع!</strong></p> </div>
                </div>
                <input type="file" id="restoreInput" accept=".json" style="display: none;" onchange="restoreLocalStorage(event)">`;
            loadViewContent('الإعدادات والنسخ الاحتياطي', contentHTML);
            updateActiveNavItem('showSettings');
        }

        // --- Show About Page ---
        function showAboutPage() {
             // console.log("Showing about page..."); // Debug log
             const contentHTML = `
                 <button onclick="showSettings()" class="back-button"> <i class="fas fa-arrow-right"></i> العودة للإعدادات </button>
                <div class="about-container">
                    <img src="logo.jpg" alt="الأيقونة" class="about-logo">
                    <h2 class="about-title">رفيق المعلم</h2>
                    <p class="about-version">الإصدار 1.1</p>
                </div>
                <div class="stats-card"> <h2><i class="fas fa-star"></i> المميزات</h2> <ul style="line-height:1.8; padding-right:20px;"> <li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>إدارة الحضور والغياب والمدفوعات.</li><li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>حساب المتأخرات تلقائياً.</li><li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>بحث سريع عن الطلاب.</li><li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>إحصائيات تفصيلية.</li><li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>تصدير Excel للمجموعات والإحصائيات.</li><li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>نسخ احتياطي واستعادة بيانات.</li><li><i class="fas fa-check-circle" style="color:#28a745;margin-left:8px;"></i>إدارة جدول المواعيد.</li></ul> </div>
                <div class="stats-card"> <h2><i class="fas fa-question-circle"></i> الاستخدام</h2> <h3 style="color:var(--primary-hover);"><i class="fas fa-users-cog"></i> المجموعات والطلاب</h3> <ul style="line-height:1.8; padding-right:20px;"> <li><strong>الإضافة/الفتح:</strong> من صفحة "المجموعات".</li> <li><strong>الحضور:</strong> المربع الأول (يمين) للحصة المحتسبة، الثاني (يسار) للحضور الفعلي.</li> <li><strong>السداد:</strong> من أعمدة السداد في الجدول.</li> <li><strong>الحذف/التعديل:</strong> الأزرار المخصصة.</li> </ul> <h3 style="color:var(--primary-hover); margin-top:1.5rem;"><i class="fas fa-clipboard-check"></i> المتابعة والإعدادات</h3> <ul style="line-height:1.8; padding-right:20px;"> <li><strong>الرئيسية/الإحصائيات:</strong> لعرض الملخصات.</li> <li><strong>البحث:</strong> الشريط العلوي.</li> <li><strong>البيانات:</strong> النسخ/الاستعادة/المسح من "الإعدادات".</li> </ul> </div>
                <div class="stats-card"> <h2><i class="fas fa-exclamation-circle"></i> نصائح</h2> <ul style="line-height:1.8; padding-right:20px;"> <li><i class="fas fa-save" style="color:var(--primary-color);margin-left:8px;"></i><strong>النسخ الاحتياطي هو الأهم!</strong></li> <li><i class="fas fa-calendar-check" style="color:var(--primary-color);margin-left:8px;"></i>سجل البيانات أولاً بأول.</li> <li><i class="fas fa-mobile-alt" style="color:var(--primary-color);margin-left:8px;"></i>ثبت التطبيق على الهاتف (Add to Home Screen).</li> <li><i class="fas fa-exclamation-triangle" style="color:#dc3545;margin-left:8px;"></i><strong>احذر عند مسح البيانات.</strong></li> </ul> </div>
                <footer class="footer-credit">
                    <p>تم التطوير بواسطة الأستاذ / يوسف الزغبي</p>
                </footer>`;
            loadViewContent('عن برنامج رفيق المعلم', contentHTML);
            updateActiveNavItem('showSettings'); // Keep Settings active
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            try {
                navigateToMainPage(); // Load the home dashboard
                updateConnectionStatus();
                setTimeout(() => { const splash = document.querySelector('.splash-screen'); if (splash) { splash.classList.add('fade-out'); splash.addEventListener('transitionend', () => splash.remove(), { once: true }); } }, 2200);
                window.addEventListener('online', updateConnectionStatus); window.addEventListener('offline', updateConnectionStatus);
                window.onerror = function(msg, src, lin, col, err) { console.error("Unhandled Error:", msg, "at", src, ":", lin, err); alert('حدث خطأ غير متوقع.'); return true; }; // Added user alert
                window.onunhandledrejection = function(event) { console.error("Unhandled Rejection:", event.reason); alert('حدث خطأ غير متوقع (Promise).'); }; // Added user alert
            } catch (error) { console.error("Initialization Error:", error); document.body.innerHTML = '<div style="padding:2rem; text-align:center;"><h1>خطأ</h1><p>حدث خطأ فادح أثناء تحميل التطبيق. يرجى المحاولة مرة أخرى أو الاتصال بالدعم.</p></div>'; } // More specific error
        });

        // --- Core Data Functions & Helpers ---
        // (Includes: updateConnectionStatus, saveData, syncPendingChanges, addGroup, deleteGroup, changeGroupName, addStudent, deleteStudent, updateStudentName, updateStudentNotes, updateMonthlyPayment, updateAttendance, updateDate, updatePayment, addNewMonth, deleteMonth, backupLocalStorage, restoreLocalStorage, clearAllDataWithConfirmation, exportToExcel, importFromExcel, calculateGroupStats, calculateAllStatistics, exportStatisticsToExcel, initializeSearch)

        function updateConnectionStatus() {
            const s = document.getElementById('connectionStatus');
            isOnline = navigator.onLine;
            if (!s) return;
            localStorage.setItem('isOnline', isOnline.toString());
            if (isOnline) {
                s.classList.remove('offline');
                s.classList.add('online');
            } else {
                s.classList.remove('online');
                s.classList.add('offline');
            }
            if (!isOnline) syncPendingChanges();
        }

        async function saveData(key, data) { try{localStorage.setItem(key,JSON.stringify(data));if(!isOnline){const p=JSON.parse(localStorage.getItem('pendingChanges')||'[]');if(!p.includes(key)){p.push(key);localStorage.setItem('pendingChanges',JSON.stringify(p))}}}catch(e){console.error(`Save Error ${key}:`,e);if(e.name==='QuotaExceededError'){alert('مساحة التخزين ممتلئة!')}else{alert(`خطأ حفظ ${key}`)}}}
        async function syncPendingChanges() { if(!isOnline)return;const p=JSON.parse(localStorage.getItem('pendingChanges')||'[]');if(p.length>0){console.log('Syncing:',p);localStorage.setItem('pendingChanges','[]');console.log('Queue cleared.')}}
        function addGroup() { let n=1; while(localStorage.getItem(`group${n}`)!==null&&n<=30)n++; if(n>30){alert('وصلت للحد الأقصى للمجموعات (30).');return} const name=prompt(`اسم المجموعة الجديدة (افتراضي: المجموعة ${n}):`,`المجموعة ${n}`); if(name===null)return; const fn=name.trim()||`المجموعة ${n}`; const d={groupName:fn,students:[],dates:Array(8).fill('')}; saveData(`group${n}`,d); alert(`تم إنشاء "${fn}".`); loadGroup(n)}
        function deleteGroup(n) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; let gn=`المجموعة ${n}`; try{gn=JSON.parse(gds).groupName||gn}catch(e){} if(!confirm(`هل أنت متأكد من حذف "${gn}" بكل بياناتها؟\nلا يمكن التراجع!`))return; try{localStorage.removeItem(`group${n}`);showGroups();alert(`تم حذف "${gn}".`)}catch(err){console.error('Delete Group Error:',err);alert('خطأ حذف المجموعة.')}}
        async function changeGroupName(n) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; let cn=`المجموعة ${n}`,gd; try{gd=JSON.parse(gds);cn=gd.groupName||cn}catch(e){alert("خطأ قراءة بيانات المجموعة.");return} const nn=prompt("الاسم الجديد للمجموعة:",cn); if(nn===null||nn.trim()==='')return; gd.groupName=nn.trim(); await saveData(`group${n}`,gd); loadGroup(n)}
        function addStudent(n) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; let gd; try{gd=JSON.parse(gds)}catch(e){alert("خطأ قراءة بيانات المجموعة.");return} if(!gd.students)gd.students=[]; const dc=gd.dates?gd.dates.length:8; const mc=Math.ceil(dc/8); const ns={name:'طالب جديد '+(gd.students.length+1),attendance:Array(dc).fill([false,false]),payments:Array(mc).fill(0),notes:'',monthlyPayment:150}; gd.students.push(ns); saveData(`group${n}`,gd); loadGroup(n); setTimeout(()=>{const tc=document.querySelector('.table-container');if(tc)tc.scrollTop=tc.scrollHeight},100)}
        function deleteStudent(n, idx) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; let gd; try{gd=JSON.parse(gds)}catch(e){alert("خطأ قراءة بيانات المجموعة.");return} if(!gd.students||idx<0||idx>=gd.students.length){console.error('Invalid student index');return} const sn=gd.students[idx].name||'الطالب'; if(!confirm(`متأكد من حذف الطالب "${sn}"؟`))return; gd.students.splice(idx,1); saveData(`group${n}`,gd); loadGroup(n); alert(`تم حذف "${sn}".`)}
        async function updateStudentName(n, idx, nn) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; try{const gd=JSON.parse(gds);if(gd.students&&gd.students[idx]){gd.students[idx].name=nn.trim();await saveData(`group${n}`,gd);const ci=document.querySelector(`#student-row-${n}-${idx} td:last-of-type input[disabled]`);if(ci)ci.value=nn.trim()}}catch(e){console.error("Name Update Error:",e)}}
        async function updateStudentNotes(n, idx, notes) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; try{const gd=JSON.parse(gds);if(gd.students&&gd.students[idx]){gd.students[idx].notes=notes;await saveData(`group${n}`,gd)}}catch(e){console.error("Notes Update Error:",e)}}
        async function updateMonthlyPayment(n, idx, val) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; try{const gd=JSON.parse(gds);const pv=parseFloat(val);if(gd.students&&gd.students[idx]){gd.students[idx].monthlyPayment=(isNaN(pv)||pv<0)?150:pv;await saveData(`group${n}`,gd);const i=document.querySelector(`#student-row-${n}-${idx} input.monthly-payment-input`);if(i)i.value=gd.students[idx].monthlyPayment;updateArrearsCell(n, idx, gd.students[idx])}}catch(e){console.error("Payment Value Update Error:",e)}}
        
        // دالة تحديث خلية المتأخرات بشكل لحظي
        function updateArrearsCell(groupNumber, studentIdx, student) {
            const mp = student.monthlyPayment || 150;
            const ps = student.payments || [];
            const totalPaid = ps.reduce((sum, p) => sum + (Number(p) || 0), 0);
            let sc = 0;
            (student.attendance || []).forEach(att => { if (att && att[0]) sc++; });
            const cp = Math.floor(sc / 8);
            const expected = cp * mp;
            const arrears = Math.max(0, expected - totalPaid);
            
            const row = document.querySelector(`#student-row-${groupNumber}-${studentIdx}`);
            if (row) {
                const arrearsCell = row.querySelector('td:last-child');
                if (arrearsCell) {
                    const hasArrears = arrears > 0;
                    const bgColor = hasArrears ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)';
                    const textColor = hasArrears ? '#dc3545' : '#28a745';
                    const content = hasArrears ? arrears + ' ج' : '<i class="fas fa-check-circle"></i>';
                    
                    arrearsCell.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; padding: 6px 10px; border-radius: 8px; background: ${bgColor}; color: ${textColor};">
                            ${content}
                        </div>
                    `;
                }
            }
        }
        
        async function updateAttendance(n, sIdx, dIdx, cbIdx, isChecked) {
            const gds = localStorage.getItem(`group${n}`);
            if (!gds) return;
            try {
                const gd = JSON.parse(gds);
                if (!gd.students || !gd.students[sIdx] || !gd.students[sIdx].attendance) {
                    console.error("Att data error:", n, sIdx, dIdx);
                    return;
                }

                // تأكد من وجود مصفوفة الحضور وإنشائها إذا لم تكن موجودة
                if (!gd.students[sIdx].attendance[dIdx]) {
                    gd.students[sIdx].attendance[dIdx] = [false, false];
                }

                const pair = [...gd.students[sIdx].attendance[dIdx]]; // Create a copy
                
                // حساب موقع الخلية بشكل صحيح مع مراعاة خلايا السداد
                const monthIndex = Math.floor(dIdx / 8);
                const dayInMonth = dIdx % 8;
                // الخلايا: اسم الطالب (1) + قيمة السداد (1) + (8 حصص + 1 سداد) * عدد الشهور السابقة + الحصة الحالية
                const cellIndex = 2 + (monthIndex * 9) + dayInMonth + 1;
                const row = document.querySelector(`#student-row-${n}-${sIdx}`);
                const cell = row ? row.querySelector(`td:nth-child(${cellIndex})`) : null;
                const cb2 = cell ? cell.querySelectorAll('input[type="checkbox"]')[1] : null;

                if (cbIdx === 0) { // تحديث حالة الاحتساب
                    pair[0] = isChecked;
                    if (!isChecked) {
                        pair[1] = false; // إعادة ضبط حالة الحضور عند إلغاء الاحتساب
                    }
                    // Update UI for checkbox 2 based on checkbox 1's state
                    if (cb2) {
                         cb2.disabled = !isChecked;
                         cb2.style.opacity = isChecked ? '1' : '0.4';
                         cb2.style.cursor = isChecked ? 'pointer' : 'not-allowed';
                         if (!isChecked) {
                             cb2.checked = false;
                         }
                    }

                } else if (cbIdx === 1) { // تحديث حالة الحضور
                    if (pair[0]) { // تحقق من أن الحصة محتسبة
                        pair[1] = isChecked;
                    } else {
                        // Prevent checking attendance if not counted
                        if (cb2) cb2.checked = false;
                        alert('لا يمكن تسجيل الحضور لحصة غير محتسبة.');
                        return; // Exit function early
                    }
                }

                gd.students[sIdx].attendance[dIdx] = pair; // Assign the updated pair
                await saveData(`group${n}`, gd);

                // After saving the attendance data, update the lesson counter
                const lessonCount = calculateCurrentLesson(gd.students[sIdx]);
                const counterElement = document.querySelector(`#student-row-${n}-${sIdx} .lesson-counter`);
                if (counterElement) {
                    counterElement.textContent = `${lessonCount.current}/8`;
                    counterElement.title = `الدورة ${lessonCount.period}`;
                    counterElement.classList.toggle('warning', lessonCount.current === 8);
                }
                
                // تحديث خلية المتأخرات بشكل لحظي
                updateArrearsCell(n, sIdx, gd.students[sIdx]);
            } catch (e) {
                console.error("Att Update Error:", e);
                alert("حدث خطأ أثناء تحديث الحضور.");
            }
        }
        async function updateDate(n, dIdx, newDate) {
            const gds = localStorage.getItem(`group${n}`);
            if (!gds) return;
            try {
                const gd = JSON.parse(gds);
                if (gd.dates && dIdx >= 0 && dIdx < gd.dates.length) {
                    const oldDate = gd.dates[dIdx]; // Store old date before updating
                    gd.dates[dIdx] = newDate;
                    await saveData(`group${n}`, gd);

                    // Update the input element directly
                    const input = document.querySelector(`#attendanceTable th:nth-of-type(${dIdx + 1}) input[type="date"]`); // More specific selector
                    if (input) {
                        input.title = newDate || 'اختر التاريخ';
                        input.setAttribute('data-date', newDate || ''); // Keep data-date attribute updated
                        // No need to update value again as the browser handles it on change
                    }
                }
            } catch(e) {
                console.error("Date Update Error:", e);
            }
        }
        async function updatePayment(n, sIdx, mIdx, val) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; try{const gd=JSON.parse(gds);const pv=parseFloat(val);if(gd.students&&gd.students[sIdx]){if(!gd.students[sIdx].payments)gd.students[sIdx].payments=[]; const el=Math.ceil(gd.dates.length/8); while(gd.students[sIdx].payments.length<el)gd.students[sIdx].payments.push(0); if(mIdx>=0&&mIdx<gd.students[sIdx].payments.length){gd.students[sIdx].payments[mIdx]=(isNaN(pv)||pv<0)?0:pv;await saveData(`group${n}`,gd);const i=document.querySelector(`#student-row-${n}-${sIdx} input[onchange*="updatePayment(${n}, ${sIdx}, ${mIdx}"]`);if(i)i.value=gd.students[sIdx].payments[mIdx];updateArrearsCell(n, sIdx, gd.students[sIdx])}}}catch(e){console.error("Payment Update Error:",e)}}
        function addNewMonth(n) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; try{const gd=JSON.parse(gds); gd.dates=[...(gd.dates||[]),...Array(8).fill('')]; const ndc=gd.dates.length; const nmc=Math.ceil(ndc/8); if(!gd.students)gd.students=[]; gd.students.forEach(s=>{s.attendance=[...(s.attendance||[]),...Array(8).fill([false,false])]; if(s.attendance.length!==ndc){const ca=Array(ndc).fill([false,false]);for(let i=0;i<Math.min(s.attendance.length,ndc);i++)ca[i]=s.attendance[i];s.attendance=ca} s.payments=s.payments||[];while(s.payments.length<nmc)s.payments.push(0)}); saveData(`group${n}`,gd); loadGroup(n)}catch(e){console.error("Add Month Error:",e);alert("خطأ إضافة شهر.")}}
        function deleteMonth(n, mIdx) { const gds=localStorage.getItem(`group${n}`); if(!gds)return; try{const gd=JSON.parse(gds);const cnd=gd.dates?gd.dates.length:0;const cnm=Math.ceil(cnd/8); if(cnd<=8){alert('لا يمكن حذف الشهر الوحيد.');return} if(mIdx<0||mIdx>=cnm){console.error("Invalid month index:",mIdx);return} if(mIdx!==cnm-1){alert('يمكن حذف الشهر الأخير فقط حالياً.');return} if(!confirm(`متأكد من حذف بيانات الشهر ${mIdx+1} بالكامل؟`))return; const si=mIdx*8;const ntd=Math.min(8,cnd-si); gd.dates.splice(si,ntd); if(gd.students){gd.students.forEach(s=>{if(s.attendance)s.attendance.splice(si,ntd);if(s.payments&&mIdx<s.payments.length)s.payments.splice(mIdx,1)})} saveData(`group${n}`,gd); loadGroup(n)}catch(err){console.error('Delete Month Error:',err);alert('خطأ حذف الشهر.')}}
        function backupLocalStorage() { try{const bd={};let f=0;for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&(k.startsWith('group')||k==='weeklySchedule' || k.startsWith('day') || k.startsWith('time'))){bd[k]=localStorage.getItem(k);f++}} if(f===0){alert("لا توجد بيانات للحفظ.");return false} const bs=JSON.stringify(bd,null,2);const blob=new Blob([bs],{type:'application/json'});const url=URL.createObjectURL(blob);const date=new Date().toISOString().slice(0,10).replace(/-/g,'');const a=document.createElement('a');a.style.display='none';a.href=url;a.download=`TeacherHelper_Backup_${date}.json`;document.body.appendChild(a);a.click();setTimeout(()=>{document.body.removeChild(a);URL.revokeObjectURL(url);alert(`تم الحفظ (${f} عنصر).\nالملف: ${a.download}`)},100);return true}catch(err){console.error('Backup Error:',err);if(err.name==='QuotaExceededError'){alert('خطأ: مساحة التخزين ممتلئة!')}else{alert('خطأ حفظ النسخة.')}return false}}
        function restoreLocalStorage(event) { const f=event.target.files[0]; if(!f)return; if(!f.name.toLowerCase().endsWith('.json')){alert("ملف غير صالح (.json مطلوب)");event.target.value='';return} if(!confirm('تحذير! سيتم استبدال البيانات الحالية ببيانات الملف.\nمتابعة؟')){event.target.value='';return} const r=new FileReader();r.onload=function(e){try{const bj=e.target.result;const bd=JSON.parse(bj);if(typeof bd!=='object'||bd===null){throw new Error('ملف النسخة تالف.')} let ir=0;const ktc=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&(k.startsWith('group')||k==='weeklySchedule' || k.startsWith('day') || k.startsWith('time'))){ktc.push(k)}} ktc.forEach(k=>localStorage.removeItem(k));console.log(`Cleared: ${ktc.join(', ')}`); for(const key in bd){if(key.startsWith('group')||key==='weeklySchedule' || key.startsWith('day') || key.startsWith('time')){if(typeof bd[key]==='string'){try{if(key.startsWith('group'))JSON.parse(bd[key]); // Basic validation for group data
                            localStorage.setItem(key,bd[key]);ir++}catch(pe){console.warn(`Skipping invalid key ${key}`)}}else{console.warn(`Skipping non-string key ${key}`)}}} if(ir===0){alert('لم يتم العثور على بيانات صالحة.')}else{alert(`تم الاستعادة (${ir} عنصر). سيتم إعادة تحميل التطبيق.`);setTimeout(()=>window.location.reload(),500)}}catch(err){console.error('Restore Error:',err);alert(`خطأ استعادة: ${err.message}`)}finally{const ri=document.getElementById('restoreInput');if(ri)ri.value=''}};r.onerror=function(){alert('خطأ قراءة الملف.');const ri=document.getElementById('restoreInput');if(ri)ri.value=''};r.readAsText(f)}
        function clearAllDataWithConfirmation() { if(!confirm('تحذير شديد!!!\n\nهل أنت متأكد تماماً من حذف *جميع* بيانات المجموعات والطلاب وجدول المواعيد؟\n\n*** لا يمكن التراجع! ***\n\nخذ نسخة احتياطية أولاً.'))return; if(!confirm('تأكيد أخير!!!\n\nسيتم حذف كل شيء الآن. متأكد 100%؟'))return; try{console.warn("Clearing all data...");const ktr=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&(k.startsWith('group')||k==='weeklySchedule' || k.startsWith('day') || k.startsWith('time')))ktr.push(k)} ktr.forEach(k=>{localStorage.removeItem(k);console.log(`Removed: ${k}`)}); alert('تم حذف جميع البيانات بنجاح. سيتم إعادة تحميل الصفحة.'); setTimeout(()=>window.location.reload(),500)}catch(err){console.error('Clear Error:',err);alert('خطأ مسح البيانات.')}}
        function importFromExcel(n) { if(typeof XLSX==='undefined'){alert('مكتبة Excel غير متاحة.');return} const fi=document.getElementById('importFile');const f=fi?.files?.[0]; if(!f){alert("اختر ملف Excel أولاً.");return} if(!confirm(`تحذير! سيتم استبدال طلاب المجموعة ببيانات الملف.\nمتابعة؟`)){fi.value='';return} const r=new FileReader();r.onload=function(e){try{const d=new Uint8Array(e.target.result);const wb=XLSX.read(d,{type:'array',cellDates:true});if(!wb.SheetNames||wb.SheetNames.length===0)throw new Error("ملف Excel فارغ.");const sn=wb.SheetNames[0];const ws=wb.Sheets[sn];const jd=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,dateNF:'yyyy-mm-dd'});if(!jd||jd.length<2)throw new Error("الورقة فارغة.");const hr=jd[0];const sdr=jd.slice(1);const nameCol=hr.findIndex(h=>h&&h.toLowerCase().includes('اسم الطالب'));const payCol=hr.findIndex(h=>h&&h.toLowerCase().includes('قيمة السداد'));const noteCol=hr.findIndex(h=>h&&h.toLowerCase().includes('ملاحظات'));if(nameCol===-1)throw new Error("لم يتم العثور على عمود 'اسم الطالب'.");let firstDateCol=(payCol!==-1)?payCol+1:nameCol+1;let lastDateCol=-1,firstPayCol=-1;for(let i=firstDateCol;i<hr.length;i++){if(hr[i]&&typeof hr[i]==='string'&&hr[i].toLowerCase().includes('سداد شهر')){firstPayCol=i;break}} if(firstPayCol!==-1){lastDateCol=firstPayCol-1}else if(noteCol!==-1){lastDateCol=noteCol-1}else{lastDateCol=hr.length-1} const dateIdxs=[],impDates=[];if(lastDateCol>=firstDateCol){for(let i=firstDateCol;i<=lastDateCol;i++){dateIdxs.push(i);let dh=hr[i];if(dh instanceof Date){const y=dh.getFullYear(),m=(dh.getMonth()+1).toString().padStart(2,'0'),d=dh.getDate().toString().padStart(2,'0');impDates.push(`${y}-${m}-${d}`)}else if(typeof dh==='string'&&/^\d{4}-\d{2}-\d{2}$/.test(dh)){impDates.push(dh)}else{impDates.push('')}}} const numDates=dateIdxs.length,numMonths=Math.ceil(numDates/8);const payIdxs=[];if(firstPayCol!==-1){let epc=(noteCol!==-1)?noteCol-firstPayCol:hr.length-firstPayCol;for(let i=0;i<epc;i++){if(hr[firstPayCol+i]?.toLowerCase().includes('سداد شهر'))payIdxs.push(firstPayCol+i);else break}} const impStuds=sdr.map(row=>{if(!row||row.length===0||!row[nameCol])return null;const s={name:row[nameCol]||'طالب',monthlyPayment:parseFloat(row[payCol])||150,attendance:Array(numDates).fill([false,false]),payments:Array(numMonths).fill(0),notes:(noteCol!==-1&&row[noteCol])?row[noteCol]:''};dateIdxs.forEach((cIdx,dArrIdx)=>{const cv=row[cIdx];if(cv==='✓')s.attendance[dArrIdx]=[true,true];else if(cv==='○')s.attendance[dArrIdx]=[true,false];else s.attendance[dArrIdx]=[false,false]});payIdxs.forEach((cIdx,mArrIdx)=>{if(mArrIdx<numMonths)s.payments[mArrIdx]=parseFloat(row[cIdx])||0});return s}).filter(s=>s!==null);const gds=localStorage.getItem(`group${n}`);let gd;try{gd=JSON.parse(gds)||{groupName:`المجموعة ${n}`}}catch(e){gd={groupName:`المجموعة ${n}`}} gd.students=impStuds;gd.dates=impDates;saveData(`group${n}`,gd);loadGroup(n);alert(`تم استيراد ${impStuds.length} طالب.`)}catch(err){console.error('Excel Import Error:',err);alert(`خطأ استيراد: ${err.message}`)}finally{fi.value=''}};r.onerror=function(){alert('خطأ قراءة الملف.');fi.value=''};r.readAsArrayBuffer(f)}
        function calculateGroupStats(groupData) { let s={collected:0,expected:0,remaining:0,attendanceRate:0};if(!groupData||!groupData.students||groupData.students.length===0)return s;let tc=0,ta=0;groupData.students.forEach(st=>{const mp=st.monthlyPayment||150;const ps=st.payments||[];s.collected+=ps.reduce((sum,p)=>sum+(Number(p)||0),0);let sc=0;(st.attendance||[]).forEach(att=>{if(att&&att[0]){sc++;tc++;if(att[1])ta++}});const cp=Math.floor(sc/8);s.expected+=cp*mp});s.remaining=s.expected-s.collected;s.attendanceRate=tc>0?Math.round((ta/tc)*100):0;s.collected=Number(s.collected.toFixed(2));s.expected=Number(s.expected.toFixed(2));s.remaining=Number(s.remaining.toFixed(2));return s}
        function calculateAllStatistics() { const os={totalCollected:0,totalExpected:0,groupStats:[],unpaidStudents:[]};for(let i=1;i<=30;i++){const gds=localStorage.getItem(`group${i}`);if(!gds)continue;try{const gd=JSON.parse(gds);if(!gd||!gd.students||gd.students.length===0)continue;const cgs={number:i,name:gd.groupName||`المجموعة ${i}`,collected:0,expected:0,remaining:0};gd.students.forEach((s)=>{if(!s)return;const mp=s.monthlyPayment||150;const ps=s.payments||[];const stp=ps.reduce((sum,p)=>sum+(Number(p)||0),0);let sc=0,sa=0;const cld=[];(s.attendance||[]).forEach((att,idx)=>{if(att&&att[0]){sc++;if(att[1])sa++;cld.push({index:idx,countedLessons: 1, attendedLessons: att[1] ? 1 : 0, date:gd.dates?.[idx]||''})}});const cp=Math.floor(sc/8);const ste=cp*mp;const sua=Math.max(0,ste-stp);cgs.collected+=stp;cgs.expected+=ste;if(sua>0){let op=0;const ad=[];for(let p=0;p<cp;p++){const pp=ps[p]||0;const io=pp<mp;if(io)op++;const psi=p*8;const pei=psi+8;const pl=cld.filter(l=>l.index>=psi&&l.index<pei);ad.push({periodNumber:p+1,countedLessons:pl.length,attendedLessons:pl.filter(l=>l.attendedLessons).length,paid:pp,expected:mp,isOverdue:io})} os.unpaidStudents.push({name:s.name||'طالب بدون اسم',groupName:cgs.name,groupNumber:i,unpaidAmount:sua,monthsOverdue:op,totalPaid:stp,totalDue:ste,expectedPerMonth:mp,attendanceDetails:ad, payments: ps})} os.totalCollected+=stp;os.totalExpected+=ste});cgs.remaining=cgs.expected-cgs.collected;if(cgs.expected>0||cgs.collected>0)os.groupStats.push(cgs)}catch(e){console.error(`Error calc full stats group ${i}:`,e)}} os.totalCollected=Number(os.totalCollected.toFixed(2));os.totalExpected=Number(os.totalExpected.toFixed(2));return os}
        function exportStatisticsToExcel() { if(typeof XLSX==='undefined'){alert('مكتبة Excel غير متاحة.');return} const stats=calculateAllStatistics();const wb=XLSX.utils.book_new();const date=new Date().toISOString().slice(0,10).replace(/-/g,''); try{if(stats.unpaidStudents.length>0){const ud=stats.unpaidStudents.map(s=>({'اسم الطالب':s.name,'المجموعة':s.groupName,'المتأخرات (ج)':s.unpaidAmount,'إجمالي المطلوب':s.totalDue,'إجمالي المدفوع':s.totalPaid,'فترات متأخرة':s.monthsOverdue,'قيمة السداد':s.expectedPerMonth}));const ws=XLSX.utils.json_to_sheet(ud);if(!ws['!props'])ws['!props']={};ws['!props'].RTL=true;ws['!cols']=[{wch:30},{wch:20},{wch:15},{wch:15},{wch:15},{wch:18},{wch:18}];XLSX.utils.book_append_sheet(wb,ws,'الطلاب المتأخرين')} if(stats.groupStats.length>0){const gd=stats.groupStats.map(g=>({'المجموعة':g.name,'المحصل':g.collected,'المتوقع':g.expected,'المتبقي':g.remaining,'التحصيل (%)':g.expected>0?Math.round((g.collected/g.expected)*100):100}));const ws=XLSX.utils.json_to_sheet(gd);if(!ws['!props'])ws['!props']={};ws['!props'].RTL=true;ws['!cols']=[{wch:30},{wch:15},{wch:15},{wch:18},{wch:18}];XLSX.utils.book_append_sheet(wb,ws,'إحصائيات المجموعات')} const sd=[{"البند":"إجمالي المحصل","القيمة":stats.totalCollected},{"البند":"إجمالي المتوقع","القيمة":stats.totalExpected},{"البند":"إجمالي المتأخرات","القيمة":stats.totalExpected-stats.totalCollected},{"البند":"عدد الطلاب المتأخرين","القيمة":stats.unpaidStudents.length},{"البند":"عدد المجموعات النشطة","القيمة":stats.groupStats.length}];const ws=XLSX.utils.json_to_sheet(sd,{skipHeader:true});if(!ws['!props'])ws['!props']={};ws['!props'].RTL=true;ws['!cols']=[{wch:25},{wch:15}];XLSX.utils.sheet_add_aoa(ws,[["البند","القيمة"]],{origin:"A1"});XLSX.utils.book_append_sheet(wb,ws,'الملخص العام'); if(wb.SheetNames.length===0){alert("لا توجد بيانات للتصدير.");return} XLSX.writeFile(wb,`TeacherHelper_Stats_${date}.xlsx`);alert('تم تصدير الإحصائيات.')}catch(err){console.error('Stats Export Error:',err);alert('خطأ تصدير الإحصائيات.')}}
        function initializeSearch() { const si=document.getElementById('searchInput');if(!si)return; si.addEventListener('input',function(){/* Optional: const st=this.value.trim(); if(st.length>=2){} else if(st.length===0){} */}); si.addEventListener('keypress',function(e){if(e.key==='Enter')showSearchPage(this.value)})}
    </script>

    <!-- SheetJS Library (XLSX) -->
    <script>
        function loadXLSXFallback() { console.warn('XLSX CDN failed, using fallback...'); const s=document.createElement('script');s.src='https://unpkg.com/xlsx/dist/xlsx.full.min.js';s.async=true;s.onload=()=>console.log('XLSX loaded via fallback.');s.onerror=function(){console.error('Failed to load XLSX from both CDNs.');alert('فشل تحميل مكتبة Excel.')};document.body.appendChild(s); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="loadXLSXFallback()" async defer></script>

</body>
</html>



